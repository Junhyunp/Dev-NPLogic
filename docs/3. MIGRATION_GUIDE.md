# NPLogic ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ

> **ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2026-01-21  
> **ëŒ€ìƒ**: ì£¼ë‹ˆì–´ ê°œë°œì / ì‹ ê·œ ì¸ìˆ˜ì¸ê³„ íŒ€  
> **ë°ì´í„°ë² ì´ìŠ¤**: Supabase (PostgreSQL 15)

---

## ğŸ“‹ ëª©ì°¨

1. [ê°œìš”](#ê°œìš”)
2. [Supabase í”„ë¡œì íŠ¸ ìƒì„±](#1-supabase-í”„ë¡œì íŠ¸-ìƒì„±)
3. [ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ë°©ë²•](#2-ë§ˆì´ê·¸ë ˆì´ì…˜-ì‹¤í–‰-ë°©ë²•)
4. [ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ëª©ë¡](#3-ë§ˆì´ê·¸ë ˆì´ì…˜-íŒŒì¼-ëª©ë¡)
5. [ì´ˆê¸° ë°ì´í„° ì„¤ì •](#4-ì´ˆê¸°-ë°ì´í„°-ì„¤ì •)
6. [Storage ë²„í‚· ì„¤ì •](#5-storage-ë²„í‚·-ì„¤ì •)
7. [RLS ì •ì±… í™•ì¸](#6-rls-ì •ì±…-í™•ì¸)
8. [íŠ¸ëŸ¬ë¸”ìŠˆíŒ…](#7-íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)
9. [ë°±ì—… ë° ë³µì›](#8-ë°±ì—…-ë°-ë³µì›)

---

## ê°œìš”

### ë§ˆì´ê·¸ë ˆì´ì…˜ì´ë€?

**ë§ˆì´ê·¸ë ˆì´ì…˜(Migration)**ì€ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ(í…Œì´ë¸” êµ¬ì¡°)ë¥¼ ë²„ì „ ê´€ë¦¬í•˜ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.

- ê° ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ì€ ë°ì´í„°ë² ì´ìŠ¤ì˜ **ë³€ê²½ ì´ë ¥**ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤
- ìˆœì„œëŒ€ë¡œ ì‹¤í–‰í•˜ë©´ **ë™ì¼í•œ DB êµ¬ì¡°**ë¥¼ ì¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
- NPLogicì€ ì´ **48ê°œì˜ ë§ˆì´ê·¸ë ˆì´ì…˜**ìœ¼ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤

### ì™œ Supabaseë¥¼ ì‚¬ìš©í•˜ë‚˜ìš”?

| íŠ¹ì§• | ì„¤ëª… |
|------|------|
| **BaaS** | Backend as a Service - ì„œë²„ ì—†ì´ DB, ì¸ì¦, ìŠ¤í† ë¦¬ì§€ ì‚¬ìš© |
| **PostgreSQL** | ê°•ë ¥í•œ ì˜¤í”ˆì†ŒìŠ¤ ê´€ê³„í˜• DB |
| **RLS** | Row Level Security - í–‰ ë‹¨ìœ„ ë³´ì•ˆ ì •ì±… |
| **ì‹¤ì‹œê°„** | Realtime ê¸°ëŠ¥ìœ¼ë¡œ ë°ì´í„° ë³€ê²½ ê°ì§€ ê°€ëŠ¥ |
| **ë¬´ë£Œ í‹°ì–´** | 500MB DB, 1GB Storage ë¬´ë£Œ |

---

## 1. Supabase í”„ë¡œì íŠ¸ ìƒì„±

### Step 1: Supabase ê³„ì • ìƒì„±

1. [https://supabase.com](https://supabase.com) ì ‘ì†
2. **Start your project** í´ë¦­
3. GitHub ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ (ê¶Œì¥) ë˜ëŠ” ì´ë©”ì¼ ê°€ì…

### Step 2: ìƒˆ í”„ë¡œì íŠ¸ ìƒì„±

1. **New Project** ë²„íŠ¼ í´ë¦­
2. í”„ë¡œì íŠ¸ ì •ë³´ ì…ë ¥:

| í•­ëª© | ê°’ | ì„¤ëª… |
|------|-----|------|
| **Name** | `nplogic-production` | í”„ë¡œì íŠ¸ëª… (ì˜ë¬¸) |
| **Database Password** | ê°•ë ¥í•œ ë¹„ë°€ë²ˆí˜¸ | âš ï¸ **ë°˜ë“œì‹œ ì €ì¥í•´ë‘ì„¸ìš”!** |
| **Region** | `Northeast Asia (Seoul)` | í•œêµ­ ë¦¬ì „ ì„ íƒ |
| **Pricing Plan** | Free ë˜ëŠ” Pro | ë¬´ë£Œë¡œ ì‹œì‘ ê°€ëŠ¥ |

3. **Create new project** í´ë¦­
4. ìƒì„±ê¹Œì§€ ì•½ 2ë¶„ ì†Œìš”

### Step 3: API í‚¤ í™•ë³´

í”„ë¡œì íŠ¸ ìƒì„± í›„, **Settings > API** ë©”ë‰´ì—ì„œ:

| í‚¤ ì´ë¦„ | ìš©ë„ | ì˜ˆì‹œ |
|---------|------|------|
| **Project URL** | API ì—”ë“œí¬ì¸íŠ¸ | `https://xxxxx.supabase.co` |
| **anon (public) key** | í´ë¼ì´ì–¸íŠ¸ìš© ê³µê°œí‚¤ | `eyJhbGciOi...` (ë§¤ìš° ê¸´ ë¬¸ìì—´) |
| **service_role key** | ì„œë²„ìš© ë¹„ë°€í‚¤ | âš ï¸ **ì ˆëŒ€ ë…¸ì¶œ ê¸ˆì§€** |

> ğŸ’¡ **Tip**: `anon key`ëŠ” í´ë¼ì´ì–¸íŠ¸ì— í¬í•¨ë˜ì–´ë„ ì•ˆì „í•©ë‹ˆë‹¤. RLS ì •ì±…ì´ ë³´ì•ˆì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.

---

## 2. ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ ë°©ë²•

### ë°©ë²• A: Supabase MCP ì‚¬ìš© (ê¶Œì¥)

Cursor IDEì—ì„œ Supabase MCPê°€ ì—°ê²°ë˜ì–´ ìˆë‹¤ë©´ ê°€ì¥ í¸ë¦¬í•©ë‹ˆë‹¤.

```
# ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš© ëª…ë ¹ (MCP)
mcp_supabase_apply_migration
  name: "create_users_table"
  query: "CREATE TABLE users (...)"
```

### ë°©ë²• B: Supabase Dashboard SQL Editor

1. Supabase Dashboard ì ‘ì†
2. ì¢Œì¸¡ ë©”ë‰´ì—ì„œ **SQL Editor** í´ë¦­
3. **New query** í´ë¦­
4. SQL ë¶™ì—¬ë„£ê¸° í›„ **Run** í´ë¦­

### ë°©ë²• C: Supabase CLI (ê³ ê¸‰)

```bash
# Supabase CLI ì„¤ì¹˜
npm install -g supabase

# ë¡œê·¸ì¸
supabase login

# í”„ë¡œì íŠ¸ ì—°ê²°
supabase link --project-ref YOUR_PROJECT_REF

# ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
supabase db push
```

---

## 3. ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ëª©ë¡

> âš ï¸ **ì¤‘ìš”**: ì•„ë˜ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤. ìˆœì„œê°€ í‹€ë¦¬ë©´ FK ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤.

### Phase 1: ê¸°ë³¸ í…Œì´ë¸” ìƒì„± (1~10)

| # | ë²„ì „ | ì´ë¦„ | ì„¤ëª… |
|---|------|------|------|
| 1 | 20251120123058 | `create_users_table` | ì‚¬ìš©ì í…Œì´ë¸” |
| 2 | 20251120123117 | `create_properties_table_v2` | ë¬¼ê±´ í…Œì´ë¸” |
| 3 | 20251120123128 | `create_data_disks_table` | ë°ì´í„°ë””ìŠ¤í¬ í…Œì´ë¸” |
| 4 | 20251120123132 | `create_registry_documents_table` | ë“±ê¸°ë¶€ë“±ë³¸ í…Œì´ë¸” |
| 5 | 20251120123135 | `create_registry_owners_table` | ë“±ê¸°ë¶€ ì†Œìœ ì í…Œì´ë¸” |
| 6 | 20251120123137 | `create_registry_rights_table` | ë“±ê¸°ë¶€ ê¶Œë¦¬ í…Œì´ë¸” |
| 7 | 20251120123146 | `create_right_analysis_table` | ê¶Œë¦¬ë¶„ì„ í…Œì´ë¸” |
| 8 | 20251120123149 | `create_evaluations_table` | í‰ê°€ í…Œì´ë¸” |
| 9 | 20251120123155 | `create_schedules_tables` | ê²½ë§¤/ê³µë§¤ ì¼ì • í…Œì´ë¸” |
| 10 | 20251120123209 | `create_system_tables` | ì‹œìŠ¤í…œ ì„¤ì • í…Œì´ë¸” |

### Phase 2: RLS ì •ì±… ì„¤ì • (11~14)

| # | ë²„ì „ | ì´ë¦„ | ì„¤ëª… |
|---|------|------|------|
| 11 | 20251120123222 | `enable_rls_users` | users í…Œì´ë¸” RLS |
| 12 | 20251120123226 | `enable_rls_properties` | properties í…Œì´ë¸” RLS |
| 13 | 20251120123232 | `enable_rls_other_tables` | ê¸°íƒ€ í…Œì´ë¸” RLS |
| 14 | 20251120123240 | `enable_rls_remaining_tables` | ë‚˜ë¨¸ì§€ í…Œì´ë¸” RLS |

### Phase 3: RLS ë²„ê·¸ ìˆ˜ì • (15~16)

| # | ë²„ì „ | ì´ë¦„ | ì„¤ëª… |
|---|------|------|------|
| 15 | 20251120150612 | `fix_users_rls_policy_recursive_issue` | ì¬ê·€ ì •ì±… ìˆ˜ì • |
| 16 | 20251121061020 | `fix_users_rls_infinite_recursion` | ë¬´í•œ ì¬ê·€ ìˆ˜ì • |

### Phase 4: ê¸°ëŠ¥ í™•ì¥ (17~28)

| # | ë²„ì „ | ì´ë¦„ | ì„¤ëª… |
|---|------|------|------|
| 17 | 20251127072247 | `add_dashboard_progress_fields` | ëŒ€ì‹œë³´ë“œ í•„ë“œ ì¶”ê°€ |
| 18 | 20251127110918 | `create_borrowers_table` | ì°¨ì£¼ í…Œì´ë¸” |
| 19 | 20251127111653 | `create_loans_table` | ëŒ€ì¶œ í…Œì´ë¸” |
| 20 | 20251127112132 | `create_reference_tables` | ê¸°ì¤€ì •ë³´ í…Œì´ë¸”ë“¤ |
| 21 | 20251127113708 | `extend_right_analysis_schema` | ê¶Œë¦¬ë¶„ì„ í™•ì¥ |
| 22 | 20251203035144 | `add_user_profile_fields` | ì‚¬ìš©ì í”„ë¡œí•„ í•„ë“œ |
| 23 | 20251203035157 | `create_programs_table` | í”„ë¡œê·¸ë¨ í…Œì´ë¸” |
| 24 | 20251203035207 | `create_program_users_table` | í”„ë¡œê·¸ë¨-ì‚¬ìš©ì ë§¤í•‘ |
| 25 | 20251203035220 | `add_program_id_to_properties` | ë¬¼ê±´ì— í”„ë¡œê·¸ë¨ID ì¶”ê°€ |
| 26 | 20251203035234 | `update_rls_policies_for_roles` | ì—­í• ë³„ RLS ì—…ë°ì´íŠ¸ |
| 27 | 20251204002204 | `fix_auth_user_id_unique_constraint` | auth_user_id ì œì•½ì¡°ê±´ ìˆ˜ì • |
| 28 | 20251215225753 | `create_auction_cases_table` | ê²½ë§¤ì‚¬ë¡€ í…Œì´ë¸” |

### Phase 5: ì¶”ê°€ ê¸°ëŠ¥ (29~40)

| # | ë²„ì „ | ì´ë¦„ | ì„¤ëª… |
|---|------|------|------|
| 29 | 20251223233614 | `add_registry_fields_for_migration` | ë“±ê¸°ë¶€ í•„ë“œ ì¶”ê°€ |
| 30 | 20251224022606 | `create_property_qa_table` | QA í…Œì´ë¸” |
| 31 | 20260104090804 | `add_missing_property_columns` | ë¬¼ê±´ ëˆ„ë½ ì»¬ëŸ¼ ì¶”ê°€ |
| 32 | 20260105041427 | `create_borrower_restructuring_table` | ì°¨ì£¼ íšŒìƒ í…Œì´ë¸” |
| 33 | 20260105123614 | `add_borrower_number_to_properties` | ë¬¼ê±´ì— ì°¨ì£¼ë²ˆí˜¸ ì¶”ê°€ |
| 34 | 20260105170142 | `add_auction_cases_rls_policy` | ê²½ë§¤ì‚¬ë¡€ RLS |
| 35 | 20260110114705 | `add_auction_schedule_type_and_capture_urls` | ê²½ë§¤ì¼ì • í•„ë“œ í™•ì¥ |
| 36 | 20260113191211 | `create_interim_tables` | ì¸í„°ë¦¼ í…Œì´ë¸”ë“¤ |
| 37 | 20260118022517 | `add_right_analysis_dd_fields` | ê¶Œë¦¬ë¶„ì„ DD í•„ë“œ |
| 38 | 20260118050341 | `add_qa_part_and_notifications` | QA íŒŒíŠ¸ ë° ì•Œë¦¼ |
| 39 | 20260118050619 | `create_public_sale_cost_standards` | ê³µë§¤ë¹„ìš© ê¸°ì¤€ í…Œì´ë¸” |
| 40 | 20260118063312 | `add_right_analysis_rls_policy` | ê¶Œë¦¬ë¶„ì„ RLS |

### Phase 6: ìµœì‹  ê¸°ëŠ¥ (41~48)

| # | ë²„ì „ | ì´ë¦„ | ì„¤ëª… |
|---|------|------|------|
| 41 | 20260118064813 | `fix_right_analysis_rls_policy` | ê¶Œë¦¬ë¶„ì„ RLS ìˆ˜ì • |
| 42 | 20260119143720 | `create_program_sheet_mappings` | ì‹œíŠ¸ ë§¤í•‘ í…Œì´ë¸” |
| 43 | 20260119210117 | `extend_auction_schedules` | ê²½ë§¤ì¼ì • ëŒ€í­ í™•ì¥ |
| 44 | 20260119210136 | `extend_public_sale_schedules` | ê³µë§¤ì¼ì • ëŒ€í­ í™•ì¥ |
| 45 | 20260119230446 | `create_evaluation_tables` | í‰ê°€ í•˜ìœ„ í…Œì´ë¸”ë“¤ |
| 46 | 20260119231059 | `add_basic_data_and_agent_fields_to_programs` | í”„ë¡œê·¸ë¨ ê¸°ì´ˆì •ë³´ í•„ë“œ |
| 47 | 20260119232138 | `add_evaluation_rental_commercial_management_tables` | ì„ëŒ€/ìƒê¶Œ/ê´€ë¦¬ë¹„ í…Œì´ë¸” |
| 48 | 20260120211450 | `add_rights_analysis_upload_count_to_properties` | ê¶Œë¦¬ë¶„ì„ ì—…ë¡œë“œ íšŒì°¨ |

---

## 4. ì´ˆê¸° ë°ì´í„° ì„¤ì •

ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ í›„, í•„ìˆ˜ ì´ˆê¸° ë°ì´í„°ë¥¼ ì‚½ì…í•´ì•¼ í•©ë‹ˆë‹¤.

### 4.1 ê´€ë¦¬ì ê³„ì • ìƒì„±

ë¨¼ì € Supabase Authenticationì—ì„œ ì‚¬ìš©ìë¥¼ ìƒì„±í•©ë‹ˆë‹¤:

1. **Authentication > Users** ë©”ë‰´
2. **Add user** > **Create new user**
3. ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ (ì˜ˆ: `admin@nplogic.com`)
4. ìƒì„±ëœ User ID (UUID) ë³µì‚¬

ê·¸ ë‹¤ìŒ users í…Œì´ë¸”ì— ì—°ê²°:

```sql
INSERT INTO users (auth_user_id, email, name, role, status)
VALUES (
  'xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx',  -- ìœ„ì—ì„œ ë³µì‚¬í•œ Auth User ID
  'admin@nplogic.com',
  'ê´€ë¦¬ì',
  'admin',
  'active'
);
```

### 4.2 ê¸°ë³¸ ì‹œìŠ¤í…œ ì„¤ì •

```sql
-- ê¸°ë³¸ ì„¤ì •ê°’ ì‚½ì…
INSERT INTO settings (setting_key, setting_value, setting_type, description)
VALUES
  ('default_recovery_rate', '{"value": 70}', 'ì‹œìŠ¤í…œí™˜ê²½', 'ê¸°ë³¸ íšŒìˆ˜ìœ¨ (%)'),
  ('ocr_batch_size', '{"value": 50}', 'ì‹œìŠ¤í…œí™˜ê²½', 'OCR ë°°ì¹˜ í¬ê¸°'),
  ('max_file_size_mb', '{"value": 50}', 'ì‹œìŠ¤í…œí™˜ê²½', 'ìµœëŒ€ íŒŒì¼ í¬ê¸° (MB)'),
  ('irr_default', '{"value": 0.15}', 'ì‹œìŠ¤í…œí™˜ê²½', 'ê¸°ë³¸ IRR (í• ì¸ìœ¨)'),
  ('auction_lead_time_months', '{"value": 6}', 'ì‹œìŠ¤í…œí™˜ê²½', 'ê²½ë§¤ 1íšŒì°¨ ë¦¬ë“œíƒ€ì„ (ê°œì›”)'),
  ('public_sale_lead_time_days', '{"value": 11}', 'ì‹œìŠ¤í…œí™˜ê²½', 'ê³µë§¤ ë¦¬ë“œíƒ€ì„ (ì¼)'),
  ('deposit_recovery_rate', '{"value": 0.90}', 'ì‹œìŠ¤í…œí™˜ê²½', 'ì˜ˆë‚©ê¸ˆ íšŒìˆ˜ìœ¨');
```

### 4.3 ë²•ì› ê¸°ì¤€ ë°ì´í„°

```sql
-- ì£¼ìš” ë²•ì› ì •ë³´ (ì €ê°ìœ¨ í¬í•¨)
INSERT INTO courts (court_code, court_name, region, discount_rate_1, discount_rate_2, discount_rate_3, discount_rate_4, is_active)
VALUES
  ('1101', 'ì„œìš¸ì¤‘ì•™ì§€ë°©ë²•ì›', 'ì„œìš¸', 0.20, 0.20, 0.20, 0.20, true),
  ('1102', 'ì„œìš¸ë™ë¶€ì§€ë°©ë²•ì›', 'ì„œìš¸', 0.20, 0.20, 0.20, 0.20, true),
  ('1103', 'ì„œìš¸ë‚¨ë¶€ì§€ë°©ë²•ì›', 'ì„œìš¸', 0.20, 0.20, 0.20, 0.20, true);
```

### 4.4 ê³µí†µ ì½”ë“œ ë°ì´í„°

```sql
-- ë¬¼ê±´ ìœ í˜• ì½”ë“œ
INSERT INTO common_codes (code_group, code_value, code_name, sort_order, is_active)
VALUES
  ('PROPERTY_TYPE', 'APT', 'ì•„íŒŒíŠ¸', 1, true),
  ('PROPERTY_TYPE', 'OFFICETEL', 'ì˜¤í”¼ìŠ¤í…”', 2, true),
  ('PROPERTY_TYPE', 'VILLA', 'ë¹Œë¼/ë‹¤ì„¸ëŒ€', 3, true),
  ('PROPERTY_TYPE', 'STORE', 'ìƒê°€', 4, true),
  ('PROPERTY_TYPE', 'OFFICE', 'ì‚¬ë¬´ì‹¤', 5, true),
  ('PROPERTY_TYPE', 'FACTORY', 'ê³µì¥', 6, true),
  ('PROPERTY_TYPE', 'WAREHOUSE', 'ì°½ê³ ', 7, true),
  ('PROPERTY_TYPE', 'LAND', 'í† ì§€', 8, true);

-- ì°¨ì£¼ ìœ í˜• ì½”ë“œ
INSERT INTO common_codes (code_group, code_value, code_name, sort_order, is_active)
VALUES
  ('BORROWER_TYPE', 'individual', 'ê°œì¸', 1, true),
  ('BORROWER_TYPE', 'business', 'ê°œì¸ì‚¬ì—…ì', 2, true),
  ('BORROWER_TYPE', 'corporation', 'ë²•ì¸', 3, true);

-- ê¶Œë¦¬ ìœ í˜• ì½”ë“œ
INSERT INTO common_codes (code_group, code_value, code_name, sort_order, is_active)
VALUES
  ('RIGHT_TYPE', 'mortgage', 'ê·¼ì €ë‹¹', 1, true),
  ('RIGHT_TYPE', 'seizure', 'ê°€ì••ë¥˜', 2, true),
  ('RIGHT_TYPE', 'provisional', 'ê°€ë“±ê¸°', 3, true),
  ('RIGHT_TYPE', 'lease', 'ì „ì„¸ê¶Œ', 4, true),
  ('RIGHT_TYPE', 'superficies', 'ì§€ìƒê¶Œ', 5, true);
```

### 4.5 ì„ëŒ€ì°¨ ë³´í˜¸ ê¸°ì¤€

```sql
-- ì£¼íƒì„ëŒ€ì°¨ ì†Œì•¡ë³´ì¦ê¸ˆ ê¸°ì¤€ (2024ë…„ ê¸°ì¤€)
INSERT INTO lease_standards (lease_type, region, start_date, deposit_limit, compensation_amount, is_active)
VALUES
  ('residential', 'ì„œìš¸', '2023-02-21', 165000000, 55000000, true),
  ('residential', 'ìˆ˜ë„ê¶Œê³¼ë°€ì–µì œê¶Œì—­', '2023-02-21', 145000000, 48000000, true),
  ('residential', 'ê´‘ì—­ì‹œë“±', '2023-02-21', 85000000, 28000000, true);
```

---

## 5. Storage ë²„í‚· ì„¤ì •

### 5.1 ë²„í‚· ìƒì„±

Supabase Dashboard > **Storage** > **New bucket**:

| ë²„í‚· ì´ë¦„ | Public | ìš©ë„ |
|----------|--------|------|
| `registry-pdfs` | No | ë“±ê¸°ë¶€ë“±ë³¸ PDF |
| `excel-files` | No | ì—…ë¡œë“œëœ ì—‘ì…€ íŒŒì¼ |
| `property-images` | No | ë¬¼ê±´ ì´ë¯¸ì§€ (ì§€ë„ ìº¡ì²˜ ë“±) |
| `exports` | No | ë‚´ë³´ë‚´ê¸° íŒŒì¼ |

### 5.2 ë²„í‚· ì •ì±… ì„¤ì •

ê° ë²„í‚·ì— RLS ì •ì±…ì„ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤:

```sql
-- registry-pdfs ë²„í‚· ì •ì±…
CREATE POLICY "Authenticated users can upload to registry-pdfs"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (bucket_id = 'registry-pdfs');

CREATE POLICY "Authenticated users can view registry-pdfs"
ON storage.objects FOR SELECT
TO authenticated
USING (bucket_id = 'registry-pdfs');

CREATE POLICY "Authenticated users can delete own files in registry-pdfs"
ON storage.objects FOR DELETE
TO authenticated
USING (bucket_id = 'registry-pdfs' AND auth.uid()::text = owner);
```

---

## 6. RLS ì •ì±… í™•ì¸

### RLSë€?

**Row Level Security (RLS)**ëŠ” PostgreSQLì˜ ê¸°ëŠ¥ìœ¼ë¡œ, í…Œì´ë¸”ì˜ ê° í–‰ì— ëŒ€í•´ ì ‘ê·¼ ê¶Œí•œì„ ì œì–´í•©ë‹ˆë‹¤.

ì˜ˆë¥¼ ë“¤ì–´:
- **í‰ê°€ì(evaluator)**ëŠ” ìì‹ ì—ê²Œ í• ë‹¹ëœ ë¬¼ê±´ë§Œ ë³¼ ìˆ˜ ìˆìŒ
- **PM**ì€ ìì‹ ì´ ë‹´ë‹¹í•˜ëŠ” í”„ë¡œê·¸ë¨ì˜ ëª¨ë“  ë¬¼ê±´ì„ ë³¼ ìˆ˜ ìˆìŒ
- **ê´€ë¦¬ì**ëŠ” ëª¨ë“  ë°ì´í„° ì ‘ê·¼ ê°€ëŠ¥

### RLS ìƒíƒœ í™•ì¸

```sql
-- ëª¨ë“  í…Œì´ë¸”ì˜ RLS ìƒíƒœ í™•ì¸
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public';
```

### ì£¼ìš” RLS ì •ì±… ì˜ˆì‹œ

```sql
-- properties í…Œì´ë¸” ì •ì±… ì˜ˆì‹œ

-- PM/ê´€ë¦¬ìëŠ” ëª¨ë“  ë¬¼ê±´ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "PM and Admin can view all properties"
ON properties FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM users
    WHERE auth_user_id = auth.uid()
    AND role IN ('pm', 'admin')
  )
);

-- í‰ê°€ìëŠ” í• ë‹¹ëœ ë¬¼ê±´ë§Œ ì¡°íšŒ ê°€ëŠ¥
CREATE POLICY "Evaluators can view assigned properties"
ON properties FOR SELECT
TO authenticated
USING (
  assigned_to IN (
    SELECT id FROM users WHERE auth_user_id = auth.uid()
  )
);
```

---

## 7. íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### 7.1 "relation does not exist" ì˜¤ë¥˜

**ì›ì¸**: ë§ˆì´ê·¸ë ˆì´ì…˜ ìˆœì„œê°€ ì˜ëª»ë¨ (FK ì°¸ì¡° í…Œì´ë¸”ì´ ì•„ì§ ì—†ìŒ)

**í•´ê²°**:
1. ë§ˆì´ê·¸ë ˆì´ì…˜ ìˆœì„œ í™•ì¸ (ë²„ì „ ë²ˆí˜¸ ìˆœì„œëŒ€ë¡œ)
2. ë¬¸ì œ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡¤ë°± í›„ ìˆœì„œëŒ€ë¡œ ì¬ì‹¤í–‰

```sql
-- í˜„ì¬ ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ í™•ì¸
SELECT * FROM supabase_migrations.schema_migrations 
ORDER BY version;
```

### 7.2 "violates foreign key constraint" ì˜¤ë¥˜

**ì›ì¸**: ì°¸ì¡°ë˜ëŠ” ë ˆì½”ë“œê°€ ì—†ëŠ”ë° FKë¥¼ ì‚½ì…í•˜ë ¤ í•¨

**í•´ê²°**:
1. ì°¸ì¡° í…Œì´ë¸”ì— ë¨¼ì € ë°ì´í„° ì‚½ì…
2. ë˜ëŠ” FK ì»¬ëŸ¼ì„ NULLë¡œ ì„¤ì •

### 7.3 "permission denied" ì˜¤ë¥˜

**ì›ì¸**: RLS ì •ì±…ì— ì˜í•´ ì ‘ê·¼ ê±°ë¶€

**í•´ê²°**:
1. ì‚¬ìš©ìì˜ ì—­í• (role) í™•ì¸
2. RLS ì •ì±… ê²€í† 
3. ì„ì‹œë¡œ RLS ë¹„í™œì„±í™”í•˜ì—¬ í…ŒìŠ¤íŠ¸

```sql
-- RLS ì„ì‹œ ë¹„í™œì„±í™” (í…ŒìŠ¤íŠ¸ìš©)
ALTER TABLE properties DISABLE ROW LEVEL SECURITY;

-- ë‹¤ì‹œ í™œì„±í™”
ALTER TABLE properties ENABLE ROW LEVEL SECURITY;
```

### 7.4 "infinite recursion" ì˜¤ë¥˜

**ì›ì¸**: RLS ì •ì±…ì´ ìê¸° ìì‹ ì„ ì°¸ì¡°í•˜ì—¬ ë¬´í•œ ë£¨í”„ ë°œìƒ

**í•´ê²°**: ì •ì±…ì—ì„œ `auth.uid()` ì§ì ‘ ì‚¬ìš©í•˜ê³ , ë‹¤ë¥¸ í…Œì´ë¸” ì¡°ì¸ ìµœì†Œí™”

```sql
-- ì˜ëª»ëœ ì˜ˆ (ë¬´í•œ ì¬ê·€ ë°œìƒ ê°€ëŠ¥)
CREATE POLICY bad_policy ON users
USING (
  EXISTS (SELECT 1 FROM users WHERE auth_user_id = auth.uid())
);

-- ì˜¬ë°”ë¥¸ ì˜ˆ
CREATE POLICY good_policy ON users
USING (auth_user_id = auth.uid());
```

### 7.5 ë§ˆì´ê·¸ë ˆì´ì…˜ ë²„ì „ ì¶©ëŒ

**ì›ì¸**: ë™ì¼í•œ ë²„ì „ì˜ ë§ˆì´ê·¸ë ˆì´ì…˜ì´ ì¤‘ë³µ ì‹¤í–‰

**í•´ê²°**:
```sql
-- ë§ˆì´ê·¸ë ˆì´ì…˜ ë²„ì „ ìˆ˜ë™ í™•ì¸
SELECT * FROM supabase_migrations.schema_migrations;

-- íŠ¹ì • ë²„ì „ ì œê±° (ì£¼ì˜!)
DELETE FROM supabase_migrations.schema_migrations 
WHERE version = '20251120123058';
```

---

## 8. ë°±ì—… ë° ë³µì›

### 8.1 Supabase ìë™ ë°±ì—…

- **ë¬´ë£Œ í”Œëœ**: 7ì¼ê°„ ì¼ì¼ ë°±ì—…
- **Pro í”Œëœ**: 30ì¼ê°„ Point-in-Time Recovery (PITR)

Dashboard > **Database > Backups**ì—ì„œ í™•ì¸

### 8.2 ìˆ˜ë™ ë°±ì—… (pg_dump)

```bash
# ë°±ì—… ìƒì„±
pg_dump -h db.xxxxx.supabase.co -p 5432 -U postgres \
  -d postgres -F c -b -v -f backup_20260121.dump

# ë¹„ë°€ë²ˆí˜¸ëŠ” í”„ë¡œì íŠ¸ ìƒì„± ì‹œ ì„¤ì •í•œ Database Password
```

### 8.3 ë³µì›

```bash
# ë³µì›
pg_restore -h db.xxxxx.supabase.co -p 5432 -U postgres \
  -d postgres -v backup_20260121.dump
```

### 8.4 íŠ¹ì • í…Œì´ë¸”ë§Œ ë°±ì—…

```bash
# properties í…Œì´ë¸”ë§Œ ë°±ì—…
pg_dump -h db.xxxxx.supabase.co -p 5432 -U postgres \
  -d postgres -t properties -F p -f properties_backup.sql
```

---

## ğŸ“Œ ì²´í¬ë¦¬ìŠ¤íŠ¸

ìƒˆ í™˜ê²½ì— ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œ í™•ì¸ ì‚¬í•­:

- [ ] Supabase í”„ë¡œì íŠ¸ ìƒì„± ì™„ë£Œ
- [ ] API URL ë° anon key í™•ë³´
- [ ] 48ê°œ ë§ˆì´ê·¸ë ˆì´ì…˜ ìˆœì„œëŒ€ë¡œ ì‹¤í–‰
- [ ] ê´€ë¦¬ì ê³„ì • ìƒì„± (Auth + users í…Œì´ë¸”)
- [ ] ê¸°ë³¸ ì‹œìŠ¤í…œ ì„¤ì • ì‚½ì…
- [ ] ê¸°ì¤€ì •ë³´ ë°ì´í„° ì‚½ì… (ë²•ì›, ê³µí†µì½”ë“œ ë“±)
- [ ] Storage ë²„í‚· 4ê°œ ìƒì„±
- [ ] Storage RLS ì •ì±… ì„¤ì •
- [ ] í…ŒìŠ¤íŠ¸ ë¡œê·¸ì¸ í™•ì¸
- [ ] ìƒ˜í”Œ ë¬¼ê±´ ì¡°íšŒ í…ŒìŠ¤íŠ¸

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- [ERD.md](./ERD.md) - ì „ì²´ í…Œì´ë¸” ê´€ê³„ ë‹¤ì´ì–´ê·¸ë¨
- [SCHEMA.md](./SCHEMA.md) - ìƒì„¸ ìŠ¤í‚¤ë§ˆ ì„¤ëª…
- [SUPABASE_CONFIG.md](./SUPABASE_CONFIG.md) - Supabase ì„¤ì • ê°€ì´ë“œ

---

**ë¬¸ì„œ ì‘ì„±ì¼**: 2026-01-21  
**ì‘ì„±ì**: NPLogic ê°œë°œíŒ€
