# LOAN 기능 구현 상세 분석 보고서

본 보고서는 NPLogic 시스템의 LOAN(대출/채권) 기능 구현 현황에 대한 기술적 분석 내용을 담고 있습니다.

## 1. 개요
LOAN 기능은 차주(Borrower)와 연계된 대출 및 채권 정보를 관리하고, 경매 시나리오에 따른 배당 가능 금액(Loan Cap)을 산출하는 핵심 모듈입니다.

## 2. 주요 구성 요소

### 2.1 데이터 모델 (`Loan.cs`)
`NPLogic.Core.Models.Loan` 클래스는 대출의 모든 속성과 비즈니스 로직을 포함합니다.

*   **채권 기본 정보**: 계좌일련번호(A), 대출과목(B), 대출종류(C), 계좌번호(D) 등
*   **금액 정보**: 최초대출원금(F), 대출원금잔액(G), 가지급금(H), 미수이자(I), 채권액 합계(J)
*   **이자율 및 날짜**: 최초대출일(E), 최종이수일(K), 정상이자율(L), 연체이자율(M)
*   **상태 정보**: 약정서 확인, 유효보증서여부(O), 기대위변제(P), MCI보증 등
*   **회수 정보 (Interim)**: 원금 상계/회수, 이자 상계/회수
*   **Loan Cap 시나리오**: 시나리오 1/2에 따른 예상배당일, 연체이자, Loan Cap 결과값

### 2.2 비즈니스 로직 (수식 구현)
대출 모델 내부에서 다음과 같은 자동 계산 로직이 구현되어 있습니다.

1.  **채권액 합계 (`CalculateTotalClaim`)**
    *   `채권액 합계 = 대출원금잔액 + 가지급금 + 미수이자`
2.  **연체이자 계산 (`CalculateOverdueInterest`)**
    *   `연체이자 = 대출원금잔액 * 연체이자율 * (예상배당일 - 최종이수일) / 365`
3.  **Loan Cap 계산 (`CalculateLoanCap`)**
    *   `Loan Cap = 대출원금잔액 + 미수이자 + 연체이자 - (원금상계 + 원금회수 + 이자상계 + 이자회수)`
    *   결과값은 0보다 작을 수 없음 (`Math.Max(0, loanCap)`)

### 2.3 데이터 접근 계층 (`LoanRepository.cs`)
Supabase(PostgreSQL)와의 통신을 담당하며, 다음과 같은 기능을 제공합니다.
*   차주별 대출 목록 필터링 및 조회
*   대출 정보의 생성, 수정, 삭제 (CRUD)
*   **통계 계산 (`GetStatisticsByBorrowerIdAsync`)**: 특정 차주의 전체 대출 건수, 원금 잔액 합계, 채권액 합계, 시나리오별 Loan Cap 합계 등을 실시간으로 산출

### 2.4 사용자 인터페이스 및 로직 (`LoanDetailViewModel.cs`)
*   **차주-대출 연동**: 선택된 차주에 해당하는 대출 목록을 자동으로 로드합니다.
*   **실시간 계산**: 사용자가 'Loan Cap 재계산' 버튼을 클릭하면 설정된 시나리오 날짜(기본 6개월/12개월 후)를 기준으로 연체이자와 Loan Cap을 다시 계산하여 저장합니다.
*   **일괄 계산**: 해당 차주의 모든 대출에 대해 Loan Cap을 한 번에 계산하는 기능을 제공합니다.

## 3. 구현 특징

1.  **시나리오 기반 분석**: 두 가지 예상 배당일(Scenario 1, Scenario 2)을 설정하여 미래 가치를 예측할 수 있도록 설계되었습니다.
2.  **데이터 무결성**: 저장 전 `CalculateTotalClaim`을 호출하여 원금과 이자의 합계가 항상 최신 상태를 유지하도록 보장합니다.
3.  **확장성**: MCI 보증 정보 등 특수 채권에 대한 필드를 별도로 관리하여 향후 보증금 청구 로직 등으로 확장 가능합니다.

## 4. 향후 개선 사항 (Roadmap)
*   Excel 내보내기 기능 (완료)
*   담보(Collateral) 정보와의 실시간 연동 강화
*   경매 진행 상황에 따른 예상 배당일 자동 업데이트 로직 추가

