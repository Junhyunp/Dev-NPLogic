# NPLogic ì„œë¹„ìŠ¤ ê°€ì´ë“œ

> **ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2026-01-21  
> **ëŒ€ìƒ**: ì£¼ë‹ˆì–´ ê°œë°œì / ì‹ ê·œ ì¸ìˆ˜ì¸ê³„ íŒ€  
> **ì•„í‚¤í…ì²˜**: MVVM + ì˜ì¡´ì„± ì£¼ì… (DI)

---

## ğŸ“‹ ëª©ì°¨

1. [ê°œìš”](#ê°œìš”)
2. [í”„ë¡œì íŠ¸ êµ¬ì¡°](#í”„ë¡œì íŠ¸-êµ¬ì¡°)
3. [í•µì‹¬ ì„œë¹„ìŠ¤](#í•µì‹¬-ì„œë¹„ìŠ¤)
4. [SupabaseService ì‚¬ìš©ë²•](#1-supabaseservice)
5. [AuthService ì‚¬ìš©ë²•](#2-authservice)
6. [CRUD íŒ¨í„´ ì˜ˆì œ](#3-crud-íŒ¨í„´-ì˜ˆì œ)
7. [Python ì„œë¹„ìŠ¤ ì—°ë™](#4-python-ì„œë¹„ìŠ¤-ì—°ë™)
8. [RLS ì •ì±…ê³¼ ê¶Œí•œ](#5-rls-ì •ì±…ê³¼-ê¶Œí•œ)
9. [ì—ëŸ¬ ì²˜ë¦¬](#6-ì—ëŸ¬-ì²˜ë¦¬)
10. [í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ](#7-í…ŒìŠ¤íŠ¸-ê°€ì´ë“œ)

---

## ê°œìš”

### ì„œë¹„ìŠ¤ ë ˆì´ì–´ë€?

**ì„œë¹„ìŠ¤(Service)**ëŠ” ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ ë°ì´í„° ì ‘ê·¼ì„ ë‹´ë‹¹í•˜ëŠ” í´ë˜ìŠ¤ì…ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    View     â”‚  â† XAML í™”ë©´
â”‚   (XAML)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ DataBinding
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚  ViewModel  â”‚  â† í™”ë©´ ë¡œì§, ìƒíƒœ ê´€ë¦¬
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ í˜¸ì¶œ
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚   Service   â”‚  â† ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§, DB ì ‘ê·¼ â­
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ API í˜¸ì¶œ
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase   â”‚  â† í´ë¼ìš°ë“œ DB
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì™œ ì„œë¹„ìŠ¤ ë ˆì´ì–´ë¥¼ ë¶„ë¦¬í•˜ë‚˜ìš”?

| ì¥ì  | ì„¤ëª… |
|------|------|
| **ì¬ì‚¬ìš©ì„±** | ì—¬ëŸ¬ ViewModelì—ì„œ ë™ì¼ ì„œë¹„ìŠ¤ ì‚¬ìš© |
| **í…ŒìŠ¤íŠ¸ ìš©ì´** | ì„œë¹„ìŠ¤ë§Œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ |
| **ìœ ì§€ë³´ìˆ˜** | DB ë³€ê²½ ì‹œ ì„œë¹„ìŠ¤ë§Œ ìˆ˜ì • |
| **ê´€ì‹¬ì‚¬ ë¶„ë¦¬** | UIëŠ” UIë§Œ, ë°ì´í„°ëŠ” ë°ì´í„°ë§Œ |

---

## í”„ë¡œì íŠ¸ êµ¬ì¡°

```
src/
â”œâ”€â”€ NPLogic.App/              # WPF ì• í”Œë¦¬ì¼€ì´ì…˜
â”‚   â”œâ”€â”€ Views/                # XAML ë·°
â”‚   â”œâ”€â”€ ViewModels/           # ë·°ëª¨ë¸
â”‚   â””â”€â”€ App.xaml.cs           # ì˜ì¡´ì„± ì£¼ì… ì„¤ì • â­
â”‚
â”œâ”€â”€ NPLogic.Core/             # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (DB ë…ë¦½ì )
â”‚   â”œâ”€â”€ Models/               # ë„ë©”ì¸ ëª¨ë¸
â”‚   â”œâ”€â”€ Services/             # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì„œë¹„ìŠ¤
â”‚   â”‚   â”œâ”€â”€ RightAnalysisRuleEngine.cs  # ê¶Œë¦¬ë¶„ì„ ë£° ì—”ì§„
â”‚   â”‚   â””â”€â”€ XnpvCalculator.cs           # XNPV ê³„ì‚°ê¸°
â”‚   â””â”€â”€ Interfaces/           # ì¸í„°í˜ì´ìŠ¤ ì •ì˜
â”‚
â”œâ”€â”€ NPLogic.Data/             # ë°ì´í„° ì ‘ê·¼ ê³„ì¸µ
â”‚   â”œâ”€â”€ Services/             # Supabase ì—°ë™ ì„œë¹„ìŠ¤ â­
â”‚   â”‚   â”œâ”€â”€ SupabaseService.cs          # Supabase í´ë¼ì´ì–¸íŠ¸
â”‚   â”‚   â”œâ”€â”€ AuthService.cs              # ì¸ì¦ ì„œë¹„ìŠ¤
â”‚   â”‚   â”œâ”€â”€ SessionStorageService.cs    # ì„¸ì…˜ ì €ì¥
â”‚   â”‚   â””â”€â”€ CommercialDistrictService.cs # ìƒê¶Œ ì„œë¹„ìŠ¤
â”‚   â””â”€â”€ Exceptions/           # ì»¤ìŠ¤í…€ ì˜ˆì™¸
â”‚
â””â”€â”€ NPLogic.UI/               # ê³µí†µ UI ì»´í¬ë„ŒíŠ¸
```

---

## í•µì‹¬ ì„œë¹„ìŠ¤

| ì„œë¹„ìŠ¤ | ìœ„ì¹˜ | ì—­í•  |
|--------|------|------|
| `SupabaseService` | NPLogic.Data | Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ë° ì—°ê²° |
| `AuthService` | NPLogic.Data | ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ/ì„¸ì…˜ ê´€ë¦¬ |
| `SessionStorageService` | NPLogic.Data | í† í° ì•”í˜¸í™” ì €ì¥ (ìë™ ë¡œê·¸ì¸) |
| `RightAnalysisRuleEngine` | NPLogic.Core | ê¶Œë¦¬ë¶„ì„ 40+ ì¼€ì´ìŠ¤ íŒë‹¨ |
| `XnpvCalculator` | NPLogic.Core | XNPV (ìˆœí˜„ì¬ê°€ì¹˜) ê³„ì‚° |

---

## 1. SupabaseService

### 1.1 ì´ˆê¸°í™”

`SupabaseService`ëŠ” ì•± ì‹œì‘ ì‹œ í•œ ë²ˆ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.

```csharp
// App.xaml.cs
public partial class App : Application
{
    public static SupabaseService SupabaseService { get; private set; } = null!;
    
    protected override async void OnStartup(StartupEventArgs e)
    {
        base.OnStartup(e);
        
        // ì„¤ì •ì—ì„œ URLê³¼ Key ë¡œë“œ
        var config = LoadConfiguration();
        
        // SupabaseService ì´ˆê¸°í™”
        SupabaseService = new SupabaseService(
            config["Supabase:Url"],
            config["Supabase:Key"]
        );
        
        await SupabaseService.InitializeAsync();
    }
}
```

### 1.2 í´ë¼ì´ì–¸íŠ¸ ê°€ì ¸ì˜¤ê¸°

```csharp
// ë°©ë²• 1: ë™ê¸°ì  (ì´ë¯¸ ì´ˆê¸°í™”ë¨ ê°€ì •)
var client = App.SupabaseService.GetClient();

// ë°©ë²• 2: ë¹„ë™ê¸° (ì„¸ì…˜ ìœ íš¨ì„± ê²€ì‚¬ í¬í•¨) - ê¶Œì¥
var client = await App.SupabaseService.GetClientAsync();
```

> âš ï¸ **ì¤‘ìš”**: `GetClientAsync()`ë¥¼ ì‚¬ìš©í•˜ë©´ ì„¸ì…˜ ë§Œë£Œ ì‹œ ìë™ìœ¼ë¡œ í† í°ì„ ê°±ì‹ í•©ë‹ˆë‹¤.

### 1.3 ì„¸ì…˜ ê´€ë¦¬

```csharp
// ì¸ì¦ ìƒíƒœ í™•ì¸
bool isLoggedIn = App.SupabaseService.IsAuthenticated();

// í˜„ì¬ ì‚¬ìš©ì ì •ë³´
var user = App.SupabaseService.GetCurrentUser();
string? email = user?.Email;

// ì„¸ì…˜ ê°€ì ¸ì˜¤ê¸°
var session = App.SupabaseService.GetSession();
string? accessToken = session?.AccessToken;

// í† í° ê°±ì‹  (ìˆ˜ë™)
bool refreshed = await App.SupabaseService.TryRefreshTokenAsync();

// ë¡œê·¸ì•„ì›ƒ
await App.SupabaseService.SignOutAsync();
```

### 1.4 ì„¸ì…˜ ë§Œë£Œ ì²˜ë¦¬

ì„¸ì…˜ì´ ë§Œë£Œë˜ë©´ `SessionExpiredException`ì´ ë°œìƒí•©ë‹ˆë‹¤.

```csharp
try
{
    var client = await App.SupabaseService.GetClientAsync();
    // ë°ì´í„° ì¡°íšŒ...
}
catch (SessionExpiredException ex)
{
    // ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
    MessageBox.Show("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
    NavigateToLoginPage();
}
```

---

## 2. AuthService

### 2.1 ì´ˆê¸°í™”

```csharp
var authService = new AuthService(App.SupabaseService);
```

### 2.2 íšŒì›ê°€ì…

```csharp
var (success, errorMessage, user) = await authService.SignUpWithEmailAsync(
    email: "user@example.com",
    password: "SecurePassword123!",
    name: "í™ê¸¸ë™",
    role: "evaluator"  // pm, evaluator, admin
);

if (success)
{
    // íšŒì›ê°€ì… ì„±ê³µ - ì´ë©”ì¼ ì¸ì¦ í•„ìš”
    MessageBox.Show("ê°€ì…í•˜ì‹  ì´ë©”ì¼ë¡œ ì¸ì¦ ë§í¬ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
}
else
{
    MessageBox.Show(errorMessage);
}
```

### 2.3 ë¡œê·¸ì¸

```csharp
var (success, errorMessage, user) = await authService.SignInWithEmailAsync(
    email: "user@example.com",
    password: "SecurePassword123!",
    rememberMe: true  // ìë™ ë¡œê·¸ì¸ ì €ì¥
);

if (success)
{
    // ë¡œê·¸ì¸ ì„±ê³µ â†’ ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
    NavigateToMainPage();
}
else
{
    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
    // "ì´ë©”ì¼ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤." ë˜ëŠ” "ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤." ë“±
    MessageBox.Show(errorMessage);
}
```

### 2.4 ìë™ ë¡œê·¸ì¸

ì•± ì‹œì‘ ì‹œ ì €ì¥ëœ í† í°ìœ¼ë¡œ ìë™ ë¡œê·¸ì¸ ì‹œë„:

```csharp
// App.xaml.cs OnStartupì—ì„œ í˜¸ì¶œ
bool autoSignedIn = await authService.TryAutoSignInAsync();

if (autoSignedIn)
{
    // ìë™ ë¡œê·¸ì¸ ì„±ê³µ â†’ ë©”ì¸ í™”ë©´
    ShowMainWindow();
}
else
{
    // í† í° ì—†ê±°ë‚˜ ë§Œë£Œ â†’ ë¡œê·¸ì¸ í™”ë©´
    ShowLoginWindow();
}
```

### 2.5 ë¡œê·¸ì•„ì›ƒ

```csharp
await authService.SignOutAsync();
// ì €ì¥ëœ í† í°ë„ í•¨ê»˜ ì‚­ì œë¨
```

### 2.6 ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •

```csharp
bool sent = await authService.SendPasswordResetEmailAsync("user@example.com");

if (sent)
{
    MessageBox.Show("ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ì„ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.");
}
```

---

## 3. CRUD íŒ¨í„´ ì˜ˆì œ

### 3.1 ë°ì´í„° ì¡°íšŒ (SELECT)

#### ì „ì²´ ì¡°íšŒ

```csharp
var client = await App.SupabaseService.GetClientAsync();

// ëª¨ë“  ë¬¼ê±´ ì¡°íšŒ
var response = await client
    .From<Property>()
    .Select("*")
    .Get();

List<Property> properties = response.Models;
```

#### ì¡°ê±´ ì¡°íšŒ (WHERE)

```csharp
// statusê°€ 'pending'ì¸ ë¬¼ê±´ë§Œ
var response = await client
    .From<Property>()
    .Select("*")
    .Where(x => x.Status == "pending")
    .Get();
```

#### ë³µí•© ì¡°ê±´

```csharp
// íŠ¹ì • í”„ë¡œê·¸ë¨ì˜ ì™„ë£Œëœ ë¬¼ê±´
var response = await client
    .From<Property>()
    .Select("*")
    .Where(x => x.ProgramId == programId)
    .Where(x => x.Status == "completed")
    .Order(x => x.CreatedAt, Postgrest.Constants.Ordering.Descending)
    .Get();
```

#### í˜ì´ì§€ë„¤ì´ì…˜

```csharp
int pageSize = 50;
int page = 1;

var response = await client
    .From<Property>()
    .Select("*")
    .Range((page - 1) * pageSize, page * pageSize - 1)
    .Get();
```

#### ê´€ê³„ ë°ì´í„° ì¡°íšŒ (JOIN)

```csharp
// ë¬¼ê±´ê³¼ ì°¨ì£¼ ì •ë³´ í•¨ê»˜ ì¡°íšŒ
var response = await client
    .From<Property>()
    .Select("*, borrower:borrowers(*)")
    .Get();
```

### 3.2 ë‹¨ê±´ ì¡°íšŒ

```csharp
// IDë¡œ ë‹¨ê±´ ì¡°íšŒ
var response = await client
    .From<Property>()
    .Select("*")
    .Where(x => x.Id == propertyId)
    .Single();

Property? property = response.Model;
```

### 3.3 ë°ì´í„° ì‚½ì… (INSERT)

```csharp
var newProperty = new Property
{
    PropertyNumber = "P-2024-001",
    PropertyType = "ì•„íŒŒíŠ¸",
    AddressFull = "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123",
    Status = "pending",
    ProgramId = currentProgramId,
    CreatedBy = currentUserId
};

var response = await client
    .From<Property>()
    .Insert(newProperty);

// ì‚½ì…ëœ ë°ì´í„° (ID í¬í•¨)
Property insertedProperty = response.Model;
```

#### ì—¬ëŸ¬ ê±´ ì‚½ì…

```csharp
var properties = new List<Property>
{
    new Property { PropertyNumber = "P-001", ... },
    new Property { PropertyNumber = "P-002", ... },
};

var response = await client
    .From<Property>()
    .Insert(properties);
```

### 3.4 ë°ì´í„° ìˆ˜ì • (UPDATE)

```csharp
// íŠ¹ì • IDì˜ ë°ì´í„° ìˆ˜ì •
var response = await client
    .From<Property>()
    .Where(x => x.Id == propertyId)
    .Set(x => x.Status, "completed")
    .Set(x => x.AppraisalConfirmed, true)
    .Set(x => x.UpdatedAt, DateTime.UtcNow)
    .Update();
```

#### ì—¬ëŸ¬ ì»¬ëŸ¼ í•œë²ˆì— ìˆ˜ì •

```csharp
var updatedProperty = new Property
{
    Status = "processing",
    AssignedTo = evaluatorId,
    UpdatedAt = DateTime.UtcNow
};

var response = await client
    .From<Property>()
    .Where(x => x.Id == propertyId)
    .Update(updatedProperty);
```

### 3.5 ë°ì´í„° ì‚­ì œ (DELETE)

```csharp
// íŠ¹ì • ID ì‚­ì œ
await client
    .From<Property>()
    .Where(x => x.Id == propertyId)
    .Delete();
```

> âš ï¸ **ì£¼ì˜**: ì‹¤ì œ ìš´ì˜ì—ì„œëŠ” ë¬¼ë¦¬ì  ì‚­ì œë³´ë‹¤ `status = 'deleted'` ê°™ì€ ì†Œí”„íŠ¸ ì‚­ì œë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.

### 3.6 ëª¨ë¸ í´ë˜ìŠ¤ ì˜ˆì‹œ

```csharp
using Postgrest.Attributes;
using Postgrest.Models;

namespace NPLogic.Core.Models
{
    [Table("properties")]
    public class Property : BaseModel
    {
        [PrimaryKey("id")]
        public Guid Id { get; set; }
        
        [Column("program_id")]
        public Guid? ProgramId { get; set; }
        
        [Column("property_number")]
        public string? PropertyNumber { get; set; }
        
        [Column("property_type")]
        public string? PropertyType { get; set; }
        
        [Column("address_full")]
        public string? AddressFull { get; set; }
        
        [Column("status")]
        public string? Status { get; set; }
        
        [Column("appraisal_value")]
        public decimal? AppraisalValue { get; set; }
        
        [Column("assigned_to")]
        public Guid? AssignedTo { get; set; }
        
        [Column("created_by")]
        public Guid? CreatedBy { get; set; }
        
        [Column("created_at")]
        public DateTime? CreatedAt { get; set; }
        
        [Column("updated_at")]
        public DateTime? UpdatedAt { get; set; }
    }
}
```

---

## 4. Python ì„œë¹„ìŠ¤ ì—°ë™

### 4.1 ê°œìš”

NPLogicì€ ë‘ ê°€ì§€ Python ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤:

| ì„œë¹„ìŠ¤ | íŒŒì¼ | ìš©ë„ |
|--------|------|------|
| **OCR í”„ë¡œì„¸ì„œ** | `python/ocr_processor.py` | ë“±ê¸°ë¶€ë“±ë³¸ PDFì—ì„œ ë°ì´í„° ì¶”ì¶œ |
| **ì¶”ì²œ í”„ë¡œì„¸ì„œ** | `python/recommend_processor.py` | ìœ ì‚¬ë¬¼ê±´ ì¶”ì²œ |

### 4.2 C#ì—ì„œ Python í˜¸ì¶œ

```csharp
using System.Diagnostics;
using System.Text.Json;

public class PythonService
{
    private readonly string _pythonPath;
    
    public PythonService(string pythonPath = "python")
    {
        _pythonPath = pythonPath;
    }
    
    /// <summary>
    /// OCR ì²˜ë¦¬
    /// </summary>
    public async Task<OcrResult> ProcessOcrAsync(string pdfPath)
    {
        var startInfo = new ProcessStartInfo
        {
            FileName = _pythonPath,
            Arguments = $"python/ocr_processor.py \"{pdfPath}\"",
            RedirectStandardOutput = true,
            RedirectStandardError = true,
            UseShellExecute = false,
            CreateNoWindow = true,
            WorkingDirectory = AppDomain.CurrentDomain.BaseDirectory
        };
        
        using var process = new Process { StartInfo = startInfo };
        process.Start();
        
        string output = await process.StandardOutput.ReadToEndAsync();
        string error = await process.StandardError.ReadToEndAsync();
        
        await process.WaitForExitAsync();
        
        if (process.ExitCode != 0)
        {
            throw new Exception($"OCR ì‹¤íŒ¨: {error}");
        }
        
        return JsonSerializer.Deserialize<OcrResult>(output)!;
    }
    
    /// <summary>
    /// ìœ ì‚¬ë¬¼ê±´ ì¶”ì²œ
    /// </summary>
    public async Task<RecommendResult> GetRecommendationsAsync(
        Property subject, 
        int topK = 10)
    {
        // ëŒ€ìƒ ë¬¼ê±´ ì •ë³´ë¥¼ JSONìœ¼ë¡œ ë³€í™˜
        var subjectJson = JsonSerializer.Serialize(new
        {
            property_id = subject.Id,
            address = subject.AddressFull,
            usage = subject.PropertyType,
            region_big = ExtractRegion(subject.AddressFull),
            land_area = subject.LandArea,
            building_area = subject.BuildingArea,
            latitude = subject.Latitude,
            longitude = subject.Longitude
        });
        
        var startInfo = new ProcessStartInfo
        {
            FileName = _pythonPath,
            Arguments = $"python/recommend_processor.py --subject-json \"{EscapeJson(subjectJson)}\" --topk {topK}",
            RedirectStandardOutput = true,
            RedirectStandardError = true,
            UseShellExecute = false,
            CreateNoWindow = true,
            WorkingDirectory = AppDomain.CurrentDomain.BaseDirectory,
            // í™˜ê²½ë³€ìˆ˜ë¡œ Supabase ì—°ê²°ì •ë³´ ì „ë‹¬
            Environment = 
            {
                ["SUPABASE_URL"] = App.SupabaseService.Url,
                ["SUPABASE_KEY"] = App.SupabaseService.Key
            }
        };
        
        using var process = new Process { StartInfo = startInfo };
        process.Start();
        
        string output = await process.StandardOutput.ReadToEndAsync();
        await process.WaitForExitAsync();
        
        return JsonSerializer.Deserialize<RecommendResult>(output)!;
    }
    
    private string EscapeJson(string json)
    {
        return json.Replace("\"", "\\\"");
    }
    
    private string? ExtractRegion(string? address)
    {
        if (string.IsNullOrEmpty(address)) return null;
        var parts = address.Split(' ');
        return parts.Length > 0 ? parts[0] : null;
    }
}
```

### 4.3 OCR ê²°ê³¼ ëª¨ë¸

```csharp
public class OcrResult
{
    public bool Success { get; set; }
    public string? Error { get; set; }
    public string? RegistryType { get; set; }
    public string? RegistryNumber { get; set; }
    public List<OwnerInfo>? Owners { get; set; }
    public List<RightInfo>? Rights { get; set; }
}

public class OwnerInfo
{
    public string? Name { get; set; }
    public string? Regno { get; set; }
    public string? ShareRatio { get; set; }
}

public class RightInfo
{
    public string? Type { get; set; }
    public int Order { get; set; }
    public string? Holder { get; set; }
    public decimal Amount { get; set; }
    public string? Date { get; set; }
}
```

### 4.4 ì¶”ì²œ ê²°ê³¼ ëª¨ë¸

```csharp
public class RecommendResult
{
    public bool Success { get; set; }
    public SubjectInfo? Subject { get; set; }
    public Dictionary<string, List<CaseInfo>>? RuleResults { get; set; }
    public int TotalCount { get; set; }
}

public class CaseInfo
{
    public string? CaseNo { get; set; }
    public string? Address { get; set; }
    public string? Usage { get; set; }
    public decimal WinningPrice { get; set; }
    public decimal AppraisalPrice { get; set; }
    public decimal WinningRate { get; set; }
    public DateTime? AuctionDate { get; set; }
    public decimal Score { get; set; }
}
```

---

## 5. RLS ì •ì±…ê³¼ ê¶Œí•œ

### 5.1 ì—­í• (Role) ë³„ ê¶Œí•œ

| ì—­í•  | `properties` | `users` | `programs` | ì„¤ëª… |
|------|-------------|---------|------------|------|
| **admin** | ëª¨ë“  ê¶Œí•œ | ëª¨ë“  ê¶Œí•œ | ëª¨ë“  ê¶Œí•œ | ì‹œìŠ¤í…œ ê´€ë¦¬ì |
| **pm** | ë‹´ë‹¹ í”„ë¡œê·¸ë¨ ì „ì²´ | ìì‹ ë§Œ | ë‹´ë‹¹ í”„ë¡œê·¸ë¨ë§Œ | í”„ë¡œì íŠ¸ ë§¤ë‹ˆì € |
| **evaluator** | í• ë‹¹ëœ ë¬¼ê±´ë§Œ | ìì‹ ë§Œ | ì½ê¸° ì „ìš© | í‰ê°€ì |

### 5.2 í˜„ì¬ ì‚¬ìš©ì ì—­í•  í™•ì¸

```csharp
public async Task<string?> GetCurrentUserRoleAsync()
{
    var client = await App.SupabaseService.GetClientAsync();
    var authUser = App.SupabaseService.GetCurrentUser();
    
    if (authUser == null) return null;
    
    var response = await client
        .From<User>()
        .Select("role")
        .Where(x => x.AuthUserId == Guid.Parse(authUser.Id))
        .Single();
    
    return response.Model?.Role;
}
```

### 5.3 ê¶Œí•œì— ë”°ë¥¸ UI ë¶„ê¸°

```csharp
// ViewModelì—ì„œ
public async Task InitializeAsync()
{
    var role = await GetCurrentUserRoleAsync();
    
    IsAdminMenuVisible = role == "admin";
    IsPmMenuVisible = role == "pm" || role == "admin";
    CanEditProperty = role != "evaluator" || await IsAssignedToMeAsync(PropertyId);
}
```

### 5.4 RLS ìš°íšŒí•˜ê¸° (ê´€ë¦¬ììš©)

ì¼ë°˜ì ìœ¼ë¡œ RLSëŠ” ìš°íšŒí•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤. í•˜ì§€ë§Œ ê´€ë¦¬ ë„êµ¬ì—ì„œ í•„ìš”í•œ ê²½ìš°:

```sql
-- service_role í‚¤ë¡œ ì ‘ì† ì‹œ RLS ë¬´ì‹œë¨
-- âš ï¸ service_role í‚¤ëŠ” ì„œë²„ì—ì„œë§Œ ì‚¬ìš©!
```

> âš ï¸ **ë³´ì•ˆ ê²½ê³ **: `service_role` í‚¤ëŠ” ì ˆëŒ€ í´ë¼ì´ì–¸íŠ¸ì— í¬í•¨í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤.

---

## 6. ì—ëŸ¬ ì²˜ë¦¬

### 6.1 ê³µí†µ ì˜ˆì™¸ íƒ€ì…

```csharp
namespace NPLogic.Data.Exceptions
{
    /// <summary>
    /// ì„¸ì…˜ ë§Œë£Œ ì˜ˆì™¸
    /// </summary>
    public class SessionExpiredException : Exception
    {
        public SessionExpiredException(string message) : base(message) { }
    }
    
    /// <summary>
    /// ê¶Œí•œ ì—†ìŒ ì˜ˆì™¸
    /// </summary>
    public class UnauthorizedException : Exception
    {
        public UnauthorizedException(string message) : base(message) { }
    }
}
```

### 6.2 ì „ì—­ ì˜ˆì™¸ ì²˜ë¦¬

```csharp
// App.xaml.cs
protected override void OnStartup(StartupEventArgs e)
{
    // UI ìŠ¤ë ˆë“œ ì˜ˆì™¸
    DispatcherUnhandledException += (s, ex) =>
    {
        if (ex.Exception is SessionExpiredException)
        {
            MessageBox.Show("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
            NavigateToLogin();
            ex.Handled = true;
            return;
        }
        
        Log.Error(ex.Exception, "Unhandled exception");
        MessageBox.Show("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "ì˜¤ë¥˜", MessageBoxButton.OK);
        ex.Handled = true;
    };
    
    // ë¹„UI ìŠ¤ë ˆë“œ ì˜ˆì™¸
    AppDomain.CurrentDomain.UnhandledException += (s, ex) =>
    {
        Log.Fatal(ex.ExceptionObject as Exception, "Fatal exception");
    };
}
```

### 6.3 ì„œë¹„ìŠ¤ ë©”ì„œë“œ ì˜ˆì™¸ ì²˜ë¦¬

```csharp
public async Task<(bool Success, string? Error, Property? Data)> GetPropertyAsync(Guid id)
{
    try
    {
        var client = await App.SupabaseService.GetClientAsync();
        
        var response = await client
            .From<Property>()
            .Where(x => x.Id == id)
            .Single();
        
        return (true, null, response.Model);
    }
    catch (SessionExpiredException)
    {
        throw; // ìƒìœ„ì—ì„œ ì²˜ë¦¬
    }
    catch (Postgrest.Exceptions.PostgrestException ex)
    {
        // RLS ì •ì±… ìœ„ë°˜ ë“±
        if (ex.Message.Contains("permission denied"))
        {
            return (false, "í•´ë‹¹ ë°ì´í„°ì— ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.", null);
        }
        return (false, $"ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜: {ex.Message}", null);
    }
    catch (Exception ex)
    {
        Log.Error(ex, "GetPropertyAsync failed");
        return (false, "ë°ì´í„° ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", null);
    }
}
```

---

## 7. í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

### 7.1 ì„œë¹„ìŠ¤ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

```csharp
[TestClass]
public class AuthServiceTests
{
    private SupabaseService _supabaseService;
    private AuthService _authService;
    
    [TestInitialize]
    public async Task Setup()
    {
        _supabaseService = new SupabaseService(
            "https://test-project.supabase.co",
            "test-anon-key"
        );
        await _supabaseService.InitializeAsync();
        _authService = new AuthService(_supabaseService);
    }
    
    [TestMethod]
    public async Task SignIn_WithValidCredentials_ShouldSucceed()
    {
        // Arrange
        var email = "test@example.com";
        var password = "TestPassword123!";
        
        // Act
        var (success, error, user) = await _authService.SignInWithEmailAsync(email, password);
        
        // Assert
        Assert.IsTrue(success);
        Assert.IsNull(error);
        Assert.IsNotNull(user);
    }
    
    [TestMethod]
    public async Task SignIn_WithInvalidPassword_ShouldFail()
    {
        // Arrange
        var email = "test@example.com";
        var password = "WrongPassword";
        
        // Act
        var (success, error, user) = await _authService.SignInWithEmailAsync(email, password);
        
        // Assert
        Assert.IsFalse(success);
        Assert.IsNotNull(error);
        Assert.IsNull(user);
    }
}
```

### 7.2 í†µí•© í…ŒìŠ¤íŠ¸ (ì‹¤ì œ DB)

```csharp
[TestClass]
public class PropertyServiceIntegrationTests
{
    [TestMethod]
    public async Task CreateAndRetrieveProperty_ShouldWork()
    {
        // 1. ë¡œê·¸ì¸
        var authService = new AuthService(App.SupabaseService);
        await authService.SignInWithEmailAsync("pm@example.com", "password");
        
        // 2. ë¬¼ê±´ ìƒì„±
        var client = await App.SupabaseService.GetClientAsync();
        var newProperty = new Property
        {
            PropertyNumber = $"TEST-{Guid.NewGuid():N}",
            Status = "pending"
        };
        
        var insertResponse = await client.From<Property>().Insert(newProperty);
        var insertedId = insertResponse.Model.Id;
        
        // 3. ì¡°íšŒ í™•ì¸
        var getResponse = await client
            .From<Property>()
            .Where(x => x.Id == insertedId)
            .Single();
        
        Assert.IsNotNull(getResponse.Model);
        Assert.AreEqual(newProperty.PropertyNumber, getResponse.Model.PropertyNumber);
        
        // 4. ì •ë¦¬ (ì‚­ì œ)
        await client.From<Property>().Where(x => x.Id == insertedId).Delete();
    }
}
```

---

## ğŸ“Œ ìš©ì–´ ì •ë¦¬

| ìš©ì–´ | ì„¤ëª… |
|------|------|
| **DI** | Dependency Injection (ì˜ì¡´ì„± ì£¼ì…) - í´ë˜ìŠ¤ ì™¸ë¶€ì—ì„œ ì˜ì¡´ ê°ì²´ ì œê³µ |
| **MVVM** | Model-View-ViewModel íŒ¨í„´ - WPFì˜ í‘œì¤€ ì•„í‚¤í…ì²˜ |
| **RLS** | Row Level Security - í–‰ ë‹¨ìœ„ ì ‘ê·¼ ì œì–´ |
| **JWT** | JSON Web Token - ì¸ì¦ í† í° í˜•ì‹ |
| **anon key** | ìµëª… í‚¤ - í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê³µê°œ í‚¤ (RLS ì ìš©ë¨) |
| **service_role key** | ì„œë¹„ìŠ¤ ì—­í•  í‚¤ - ì„œë²„ì—ì„œë§Œ ì‚¬ìš©í•˜ëŠ” ë¹„ë°€ í‚¤ (RLS ìš°íšŒ) |

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- [ERD.md](../database/ERD.md) - ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡°
- [MIGRATION_GUIDE.md](../database/MIGRATION_GUIDE.md) - DB ë§ˆì´ê·¸ë ˆì´ì…˜
- [ENVIRONMENT_SETUP.md](../setup/ENVIRONMENT_SETUP.md) - ê°œë°œ í™˜ê²½ ì„¤ì •
- [BUSINESS_LOGIC.md](../business/BUSINESS_LOGIC.md) - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìƒì„¸

---

**ë¬¸ì„œ ì‘ì„±ì¼**: 2026-01-21  
**ì‘ì„±ì**: NPLogic ê°œë°œíŒ€
