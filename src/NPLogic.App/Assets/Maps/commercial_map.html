<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒê¶Œ ë¶„ì„ ì§€ë„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
            background: #f5f5f5;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* API í‚¤ ì—†ì„ ë•Œ í‘œì‹œí•  ë©”ì‹œì§€ */
        #no-api-key {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a2744 0%, #2d3a52 100%);
            color: white;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            text-align: center;
            padding: 40px;
        }
        
        #no-api-key.show {
            display: flex;
        }
        
        #no-api-key h2 {
            font-size: 24px;
            margin-bottom: 16px;
            color: #90cdf4;
        }
        
        #no-api-key p {
            font-size: 14px;
            line-height: 1.6;
            opacity: 0.8;
            max-width: 400px;
        }
        
        /* ì»¤ìŠ¤í…€ ì¸í¬ìœˆë„ìš° - ë¬¼ê±´ */
        .property-infowindow {
            padding: 12px 16px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 180px;
            max-width: 280px;
            border-left: 4px solid #1E3A5F;
        }
        
        .property-infowindow .title {
            font-size: 14px;
            font-weight: 700;
            color: #1E3A5F;
            margin-bottom: 6px;
        }
        
        .property-infowindow .address {
            font-size: 12px;
            color: #64748b;
            line-height: 1.4;
        }
        
        .property-infowindow .badge {
            display: inline-block;
            background: #1E3A5F;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 8px;
        }
        
        /* ì»¤ìŠ¤í…€ ì¸í¬ìœˆë„ìš° - ì í¬ */
        .store-infowindow {
            padding: 10px 14px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
            min-width: 150px;
            max-width: 220px;
        }
        
        .store-infowindow .store-name {
            font-size: 13px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .store-infowindow .industry {
            font-size: 11px;
            color: #6b7280;
        }
        
        .store-infowindow .industry-badge {
            display: inline-block;
            background: #f3f4f6;
            color: #374151;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-top: 6px;
        }
        
        /* ë²”ë¡€ */
        #legend {
            position: absolute;
            bottom: 16px;
            left: 16px;
            background: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
            font-size: 12px;
        }
        
        #legend .legend-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }
        
        #legend .legend-item {
            display: flex;
            align-items: center;
            margin: 4px 0;
        }
        
        #legend .legend-marker {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        #legend .property-marker {
            background: #1E3A5F;
            border: 2px solid white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        #legend .store-marker {
            background: #F59E0B;
            border: 2px solid white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        
        /* ë¡œë”© ì¸ë””ì¼€ì´í„° */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #64748b;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="no-api-key">
        <div style="font-size: 64px; margin-bottom: 24px; opacity: 0.6;">ğŸ—ºï¸</div>
        <h2>ì¹´ì¹´ì˜¤ë§µ API í‚¤ í•„ìš”</h2>
        <p>
            ì§€ë„ë¥¼ í‘œì‹œí•˜ë ¤ë©´ ì¹´ì¹´ì˜¤ë§µ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.<br><br>
            appsettings.jsonì— KakaoMapApiKeyë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.
        </p>
    </div>
    <div id="loading">
        <div class="spinner"></div>
        <div>ì§€ë„ ë¡œë”© ì¤‘...</div>
    </div>
    <div id="legend" style="display: none;">
        <div class="legend-title">ë²”ë¡€</div>
        <div class="legend-item">
            <div class="legend-marker property-marker"></div>
            <span>ë¶„ì„ ëŒ€ìƒ ë¬¼ê±´</span>
        </div>
        <div class="legend-item">
            <div class="legend-marker store-marker"></div>
            <span>ì£¼ë³€ ì í¬</span>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let map = null;
        let propertyMarker = null;
        let storeMarkers = [];
        let radiusCircle = null;
        let currentInfowindow = null;
        let isMapReady = false;
        let apiKey = null;
        let clusterer = null;

        // C#ì—ì„œ í˜¸ì¶œ: API í‚¤ ì„¤ì • ë° ì§€ë„ ì´ˆê¸°í™”
        function initializeMap(key) {
            apiKey = key;
            
            if (!key || key === '' || key === 'YOUR_KAKAO_MAP_API_KEY') {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('no-api-key').classList.add('show');
                return;
            }

            // ì¹´ì¹´ì˜¤ë§µ ìŠ¤í¬ë¦½íŠ¸ ë™ì  ë¡œë“œ (clusterer ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬í•¨)
            const script = document.createElement('script');
            script.src = `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${key}&autoload=false&libraries=services,clusterer`;
            script.onload = function() {
                kakao.maps.load(function() {
                    createMap();
                });
            };
            script.onerror = function() {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('no-api-key').classList.add('show');
            };
            document.head.appendChild(script);
        }

        // ì§€ë„ ìƒì„±
        function createMap() {
            const container = document.getElementById('map');
            const options = {
                center: new kakao.maps.LatLng(37.5665, 126.9780),
                level: 4
            };
            
            map = new kakao.maps.Map(container, options);
            isMapReady = true;
            
            // í´ëŸ¬ìŠ¤í„°ëŸ¬ ì´ˆê¸°í™”
            clusterer = new kakao.maps.MarkerClusterer({
                map: map,
                averageCenter: true,
                minLevel: 5,
                disableClickZoom: true,
                styles: [{
                    width: '40px',
                    height: '40px',
                    background: 'rgba(245, 158, 11, 0.9)',
                    borderRadius: '20px',
                    color: '#fff',
                    textAlign: 'center',
                    fontWeight: 'bold',
                    lineHeight: '40px',
                    fontSize: '14px'
                }]
            });
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('legend').style.display = 'block';
            
            // ì§€ë„ ì»¨íŠ¸ë¡¤ ì¶”ê°€
            const zoomControl = new kakao.maps.ZoomControl();
            map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);
            
            // C#ì— ì¤€ë¹„ ì™„ë£Œ ì•Œë¦¼
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage(JSON.stringify({ type: 'mapReady' }));
            }
        }

        // ë¬¼ê±´ ìœ„ì¹˜ì— ë§ˆì»¤ í‘œì‹œ
        function setPropertyMarker(lat, lng, address, propertyNumber) {
            if (!isMapReady || !map) return;

            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            if (propertyMarker) {
                propertyMarker.setMap(null);
            }

            const position = new kakao.maps.LatLng(lat, lng);
            
            // ì»¤ìŠ¤í…€ ë§ˆì»¤ ì´ë¯¸ì§€ (ë¬¼ê±´ìš© - ë‚¨ìƒ‰)
            const markerImage = new kakao.maps.MarkerImage(
                'data:image/svg+xml;base64,' + btoa(`
                    <svg xmlns="http://www.w3.org/2000/svg" width="36" height="48" viewBox="0 0 36 48">
                        <path d="M18 0C8.06 0 0 8.06 0 18c0 13.5 18 30 18 30s18-16.5 18-30C36 8.06 27.94 0 18 0z" fill="#1E3A5F"/>
                        <circle cx="18" cy="18" r="8" fill="white"/>
                        <circle cx="18" cy="18" r="4" fill="#1E3A5F"/>
                    </svg>
                `),
                new kakao.maps.Size(36, 48),
                { offset: new kakao.maps.Point(18, 48) }
            );

            propertyMarker = new kakao.maps.Marker({
                position: position,
                map: map,
                image: markerImage,
                zIndex: 100
            });

            // ì¸í¬ìœˆë„ìš°
            const content = `
                <div class="property-infowindow">
                    <div class="title">${propertyNumber || 'ë¶„ì„ ëŒ€ìƒ ë¬¼ê±´'}</div>
                    <div class="address">${address || 'ì£¼ì†Œ ì •ë³´ ì—†ìŒ'}</div>
                    <div class="badge">ë¶„ì„ ëŒ€ìƒ</div>
                </div>
            `;

            const infowindow = new kakao.maps.InfoWindow({
                content: content,
                removable: true
            });

            kakao.maps.event.addListener(propertyMarker, 'click', function() {
                if (currentInfowindow) currentInfowindow.close();
                infowindow.open(map, propertyMarker);
                currentInfowindow = infowindow;
            });

            // ì§€ë„ ì¤‘ì‹¬ ì´ë™
            map.setCenter(position);
            
            // ê¸°ë³¸ìœ¼ë¡œ ì¸í¬ìœˆë„ìš° ì—´ê¸°
            infowindow.open(map, propertyMarker);
            currentInfowindow = infowindow;
        }

        // ë°˜ê²½ ì› í‘œì‹œ
        function setRadius(radius) {
            if (!isMapReady || !map || !propertyMarker) return;

            // ê¸°ì¡´ ì› ì œê±°
            if (radiusCircle) {
                radiusCircle.setMap(null);
            }

            radiusCircle = new kakao.maps.Circle({
                center: propertyMarker.getPosition(),
                radius: radius,
                strokeWeight: 2,
                strokeColor: '#1E3A5F',
                strokeOpacity: 0.8,
                strokeStyle: 'dashed',
                fillColor: '#1E3A5F',
                fillOpacity: 0.1
            });

            radiusCircle.setMap(map);

            // ì¤Œ ë ˆë²¨ ì¡°ì •
            const level = radius <= 200 ? 3 : radius <= 500 ? 4 : radius <= 1000 ? 5 : 6;
            map.setLevel(level);
        }

        // ì£¼ë³€ ì í¬ ë§ˆì»¤ í‘œì‹œ
        function displayStores(storesJson) {
            if (!isMapReady || !map) return;

            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            clearStoreMarkers();

            const stores = typeof storesJson === 'string' ? JSON.parse(storesJson) : storesJson;
            
            if (!stores || stores.length === 0) return;

            // ì í¬ ë§ˆì»¤ ì´ë¯¸ì§€ (ì£¼í™©ìƒ‰)
            const markerImage = new kakao.maps.MarkerImage(
                'data:image/svg+xml;base64,' + btoa(`
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10" fill="#F59E0B" stroke="white" stroke-width="2"/>
                        <circle cx="12" cy="12" r="4" fill="white"/>
                    </svg>
                `),
                new kakao.maps.Size(24, 24),
                { offset: new kakao.maps.Point(12, 12) }
            );

            stores.forEach(function(store, index) {
                if (!store.lat || !store.lng) return;

                const position = new kakao.maps.LatLng(store.lat, store.lng);
                
                const marker = new kakao.maps.Marker({
                    position: position,
                    image: markerImage,
                    zIndex: 10
                });

                const content = `
                    <div class="store-infowindow">
                        <div class="store-name">${store.name || 'ì í¬'}</div>
                        <div class="industry">${store.industry || '-'}</div>
                    </div>
                `;

                const infowindow = new kakao.maps.InfoWindow({
                    content: content,
                    removable: true
                });

                kakao.maps.event.addListener(marker, 'click', function() {
                    if (currentInfowindow) currentInfowindow.close();
                    infowindow.open(map, marker);
                    currentInfowindow = infowindow;
                    
                    // C#ì— ì í¬ í´ë¦­ ì•Œë¦¼
                    if (window.chrome && window.chrome.webview) {
                        window.chrome.webview.postMessage(JSON.stringify({ 
                            type: 'storeClick', 
                            storeName: store.name,
                            industry: store.industry
                        }));
                    }
                });

                storeMarkers.push(marker);
            });

            // í´ëŸ¬ìŠ¤í„°ëŸ¬ì— ë§ˆì»¤ ì¶”ê°€
            clusterer.addMarkers(storeMarkers);
        }

        // ì í¬ ë§ˆì»¤ ì œê±°
        function clearStoreMarkers() {
            if (clusterer) {
                clusterer.clear();
            }
            
            storeMarkers.forEach(function(marker) {
                marker.setMap(null);
            });
            storeMarkers = [];
        }

        // ì¤Œ ì¸
        function zoomIn() {
            if (!isMapReady || !map) return;
            const level = map.getLevel();
            if (level > 1) map.setLevel(level - 1);
        }

        // ì¤Œ ì•„ì›ƒ
        function zoomOut() {
            if (!isMapReady || !map) return;
            const level = map.getLevel();
            if (level < 14) map.setLevel(level + 1);
        }
    </script>
</body>
</html>
