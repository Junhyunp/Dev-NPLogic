<UserControl x:Class="NPLogic.Views.InterimTab"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:NPLogic.Views"
             xmlns:vm="clr-namespace:NPLogic.ViewModels"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1200"
             d:DataContext="{d:DesignInstance Type=vm:InterimTabViewModel}">

    <UserControl.Resources>
        <Style x:Key="SectionHeaderStyle" TargetType="TextBlock" BasedOn="{StaticResource SectionHeader}">
            <Setter Property="FontSize" Value="{StaticResource FontSizeH4}"/>
        </Style>
        <Style x:Key="CardStyle" TargetType="Border" BasedOn="{StaticResource CardBorder}">
            <Setter Property="Padding" Value="16"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
        <Border Background="{StaticResource OverlaySemiLightBrush}" 
                Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}"
                Panel.ZIndex="100">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="200" Height="4"/>
                <TextBlock Text="ë¡œë”© ì¤‘..." Margin="0,12,0,0" 
                           HorizontalAlignment="Center"
                           Style="{StaticResource BodyTextStyle}"/>
            </StackPanel>
        </Border>

        <Grid Margin="12,8,12,12">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- í—¤ë” ì˜ì—­ -->
            <Border Grid.Row="0" Style="{StaticResource CardStyle}" Margin="0,0,0,16">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- ì œëª© ë° í†µê³„ -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="ðŸ’° ì¸í„°ë¦¼ ê´€ë¦¬" Style="{StaticResource SectionHeaderStyle}" Margin="0,0,24,0"/>
                        
                        <Border Background="{StaticResource BlueGray50Brush}" CornerRadius="4" Padding="12,6" Margin="0,0,12,0">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ì°¨ì£¼: " Foreground="{StaticResource TextMutedBrush}" FontSize="{StaticResource FontSizeBody}"/>
                                <TextBlock Text="{Binding TotalBorrowerCount}" FontWeight="SemiBold" FontSize="{StaticResource FontSizeBody}"/>
                                <TextBlock Text="ê°œ" Foreground="{StaticResource TextMutedBrush}" FontSize="{StaticResource FontSizeBody}"/>
                            </StackPanel>
                        </Border>
                        
                        <Border Background="{StaticResource WarningLightBrush}" CornerRadius="4" Padding="12,6" Margin="0,0,12,0">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ê°€ì§€ê¸‰ê¸ˆ: " Foreground="{StaticResource TextMutedBrush}" FontSize="{StaticResource FontSizeBody}"/>
                                <TextBlock Text="{Binding TotalAdvance, StringFormat=N0}" FontWeight="SemiBold" FontSize="{StaticResource FontSizeBody}" Foreground="{StaticResource WarningBrush}"/>
                                <TextBlock Text="ì›" Foreground="{StaticResource TextMutedBrush}" FontSize="{StaticResource FontSizeBody}"/>
                            </StackPanel>
                        </Border>
                        
                        <Border Background="{StaticResource SuccessLightBrush}" CornerRadius="4" Padding="12,6" Margin="0,0,12,0">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="íšŒìˆ˜ì´ì•¡: " Foreground="{StaticResource TextMutedBrush}" FontSize="{StaticResource FontSizeBody}"/>
                                <TextBlock Text="{Binding TotalCollection, StringFormat=N0}" FontWeight="SemiBold" FontSize="{StaticResource FontSizeBody}" Foreground="{StaticResource SuccessBrush}"/>
                                <TextBlock Text="ì›" Foreground="{StaticResource TextMutedBrush}" FontSize="{StaticResource FontSizeBody}"/>
                            </StackPanel>
                        </Border>
                        
                        <Border Background="{StaticResource PrimaryLightBrush}" CornerRadius="4" Padding="12,6">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ìˆœìˆ˜ìµ: " Foreground="{StaticResource TextMutedBrush}" FontSize="{StaticResource FontSizeBody}"/>
                                <TextBlock Text="{Binding TotalNet, StringFormat=N0}" FontWeight="Bold" FontSize="{StaticResource FontSizeBody}" Foreground="{StaticResource PrimaryBrush}"/>
                                <TextBlock Text="ì›" Foreground="{StaticResource TextMutedBrush}" FontSize="{StaticResource FontSizeBody}"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>

                    <!-- ë²„íŠ¼ ì˜ì—­ -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <Button Style="{StaticResource PrimaryButton}"
                                Command="{Binding UploadInterimFileCommand}"
                                Padding="12,8"
                                Margin="0,0,8,0">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="Upload" Width="16" Height="16" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                <TextBlock Text="ì¸í„°ë¦¼ íŒŒì¼ ì—…ë¡œë“œ" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        
                        <Button Style="{StaticResource SecondaryButton}"
                                Command="{Binding ExportToExcelCommand}"
                                Padding="12,8"
                                Margin="0,0,8,0">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="MicrosoftExcel" Width="16" Height="16" VerticalAlignment="Center" Foreground="#217346" Margin="0,0,6,0"/>
                                <TextBlock Text="Excel ë‹¤ìš´ë¡œë“œ" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                        
                        <Button Style="{StaticResource SecondaryButton}"
                                Command="{Binding LoadDataCommand}"
                                Padding="12,8">
                            <StackPanel Orientation="Horizontal">
                                <materialDesign:PackIcon Kind="Refresh" Width="16" Height="16" VerticalAlignment="Center" Margin="0,0,6,0"/>
                                <TextBlock Text="ìƒˆë¡œê³ ì¹¨" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- ë©”ì¸ ì»¨í…ì¸ : ì¢Œì¸¡ ì°¨ì£¼ëª©ë¡ + ìš°ì¸¡ ìƒì„¸ -->
            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="350"/>
                    <ColumnDefinition Width="16"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- ì¢Œì¸¡: ì°¨ì£¼ ëª©ë¡ -->
                <Border Grid.Column="0" Style="{StaticResource CardStyle}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.Row="0" Text="ðŸ“‹ ì°¨ì£¼ë³„ ì¸í„°ë¦¼ í˜„í™©" Style="{StaticResource SectionHeaderStyle}" Margin="0,0,0,12"/>

                        <DataGrid Grid.Row="1"
                                  ItemsSource="{Binding BorrowerSummaries}"
                                  SelectedItem="{Binding SelectedBorrower}"
                                  AutoGenerateColumns="False"
                                  IsReadOnly="True"
                                  SelectionMode="Single"
                                  CanUserAddRows="False"
                                  CanUserDeleteRows="False"
                                  HeadersVisibility="Column"
                                  GridLinesVisibility="Horizontal"
                                  BorderThickness="1"
                                  BorderBrush="{StaticResource BorderBrush}">
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="ì°¨ì£¼ë²ˆí˜¸" Binding="{Binding BorrowerNumber}" Width="90"/>
                                <DataGridTextColumn Header="ì°¨ì£¼ëª…" Binding="{Binding BorrowerName}" Width="80"/>
                                <DataGridTextColumn Header="ê°€ì§€ê¸‰ê¸ˆ" Binding="{Binding AdvanceTotalDisplay}" Width="90">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="HorizontalAlignment" Value="Right"/>
                                            <Setter Property="Foreground" Value="{StaticResource WarningBrush}"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                                <DataGridTextColumn Header="íšŒìˆ˜ì´ì•¡" Binding="{Binding CollectionTotalDisplay}" Width="*">
                                    <DataGridTextColumn.ElementStyle>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="HorizontalAlignment" Value="Right"/>
                                            <Setter Property="Foreground" Value="{StaticResource SuccessBrush}"/>
                                        </Style>
                                    </DataGridTextColumn.ElementStyle>
                                </DataGridTextColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </Border>

                <!-- ìš°ì¸¡: ì„ íƒëœ ì°¨ì£¼ ìƒì„¸ -->
                <Grid Grid.Column="2">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="16"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- ê°€ì§€ê¸‰ê¸ˆ (InterimAdvance) -->
                    <Border Grid.Row="0" Style="{StaticResource CardStyle}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,12">
                                <TextBlock Text="ðŸ“¤ ê°€ì§€ê¸‰ê¸ˆ (ë°œìƒì•¡)" Style="{StaticResource SectionHeaderStyle}"/>
                                <Border Background="{StaticResource WarningLightBrush}" CornerRadius="4" Padding="8,2" Margin="12,0,0,0" VerticalAlignment="Center">
                                    <TextBlock FontSize="{StaticResource FontSizeSmall}">
                                        <Run Text="{Binding Advances.Count, Mode=OneWay}"/>
                                        <Run Text="ê±´"/>
                                    </TextBlock>
                                </Border>
                            </StackPanel>

                            <DataGrid Grid.Row="1"
                                      ItemsSource="{Binding Advances}"
                                      AutoGenerateColumns="False"
                                      IsReadOnly="True"
                                      CanUserAddRows="False"
                                      HeadersVisibility="Column"
                                      GridLinesVisibility="Horizontal"
                                      BorderThickness="1"
                                      BorderBrush="{StaticResource BorderBrush}">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="ë¹„ìš©ì¢…ë¥˜" Binding="{Binding ExpenseType}" Width="100"/>
                                    <DataGridTextColumn Header="ê±°ëž˜ì¼ìž" Binding="{Binding TransactionDate, StringFormat=yyyy-MM-dd}" Width="100"/>
                                    <DataGridTextColumn Header="ê³„ì¢Œë²ˆí˜¸" Binding="{Binding AccountNumber}" Width="120"/>
                                    <DataGridTextColumn Header="ê¸ˆì•¡" Binding="{Binding Amount, StringFormat=N0}" Width="120">
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="HorizontalAlignment" Value="Right"/>
                                                <Setter Property="FontWeight" Value="SemiBold"/>
                                            </Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Header="ë¹„ê³ " Binding="{Binding Notes}" Width="*"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </Border>

                    <!-- íšŒìˆ˜ì •ë³´ (InterimCollection) -->
                    <Border Grid.Row="2" Style="{StaticResource CardStyle}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,12">
                                <TextBlock Text="ðŸ“¥ íšŒìˆ˜ì •ë³´" Style="{StaticResource SectionHeaderStyle}"/>
                                <Border Background="{StaticResource SuccessLightBrush}" CornerRadius="4" Padding="8,2" Margin="12,0,0,0" VerticalAlignment="Center">
                                    <TextBlock FontSize="{StaticResource FontSizeSmall}">
                                        <Run Text="{Binding Collections.Count, Mode=OneWay}"/>
                                        <Run Text="ê±´"/>
                                    </TextBlock>
                                </Border>
                            </StackPanel>

                            <DataGrid Grid.Row="1"
                                      ItemsSource="{Binding Collections}"
                                      AutoGenerateColumns="False"
                                      IsReadOnly="True"
                                      CanUserAddRows="False"
                                      HeadersVisibility="Column"
                                      GridLinesVisibility="Horizontal"
                                      BorderThickness="1"
                                      BorderBrush="{StaticResource BorderBrush}">
                                <DataGrid.Columns>
                                    <DataGridTextColumn Header="íšŒìˆ˜ì¼ìž" Binding="{Binding CollectionDate, StringFormat=yyyy-MM-dd}" Width="100"/>
                                    <DataGridTextColumn Header="ê³„ì¢Œë²ˆí˜¸" Binding="{Binding AccountNumber}" Width="120"/>
                                    <DataGridTextColumn Header="íšŒìˆ˜ì›ê¸ˆ" Binding="{Binding PrincipalAmount, StringFormat=N0}" Width="110">
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="HorizontalAlignment" Value="Right"/>
                                            </Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Header="íšŒìˆ˜ì´ìž" Binding="{Binding InterestAmount, StringFormat=N0}" Width="110">
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="HorizontalAlignment" Value="Right"/>
                                            </Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Header="ì´íšŒìˆ˜ì•¡" Binding="{Binding TotalAmount, StringFormat=N0}" Width="120">
                                        <DataGridTextColumn.ElementStyle>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="HorizontalAlignment" Value="Right"/>
                                                <Setter Property="FontWeight" Value="Bold"/>
                                                <Setter Property="Foreground" Value="{StaticResource SuccessBrush}"/>
                                            </Style>
                                        </DataGridTextColumn.ElementStyle>
                                    </DataGridTextColumn>
                                    <DataGridTextColumn Header="ë¹„ê³ " Binding="{Binding Notes}" Width="*"/>
                                </DataGrid.Columns>
                            </DataGrid>
                        </Grid>
                    </Border>
                </Grid>
            </Grid>

            <!-- í•˜ë‹¨ ìƒíƒœ í‘œì‹œ -->
            <Border Grid.Row="2" Background="{StaticResource BlueGray50Brush}" CornerRadius="4" Padding="12,8" Margin="0,16,0,0">
                <TextBlock Text="{Binding StatusMessage}"
                           FontSize="{StaticResource FontSizeBody}"
                           Foreground="{StaticResource TextMutedBrush}"/>
            </Border>
        </Grid>
    </Grid>
</UserControl>
