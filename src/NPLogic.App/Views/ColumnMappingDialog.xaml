<Window x:Class="NPLogic.Views.ColumnMappingDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
        Title="컬럼 매핑"
        Height="600" Width="800"
        WindowStartupLocation="CenterOwner"
        ResizeMode="CanResize"
        MinWidth="600" MinHeight="400"
        Background="{DynamicResource BackgroundBrush}">
    
    <Window.Resources>
        <!-- 컨버터 -->
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        
        <!-- 로컬 색상 정의 (App.xaml 리소스 접근 문제 해결) -->
        <SolidColorBrush x:Key="LocalPrimaryBrush" Color="#1565C0"/>
        <SolidColorBrush x:Key="LocalSecondaryTextBrush" Color="#607D8B"/>
        <SolidColorBrush x:Key="LocalSuccessBrush" Color="#4CAF50"/>
        <SolidColorBrush x:Key="LocalInfoBrush" Color="#2196F3"/>
        <SolidColorBrush x:Key="LocalErrorBrush" Color="#F44336"/>
        <SolidColorBrush x:Key="LocalBorderBrush" Color="#E0E0E0"/>
        <SolidColorBrush x:Key="LocalSurfaceBrush" Color="#FFFFFF"/>
        <SolidColorBrush x:Key="LocalBlueGray50Brush" Color="#ECEFF1"/>
        <SolidColorBrush x:Key="LocalBlueGray100Brush" Color="#CFD8DC"/>
        
        <Style x:Key="MappingComboBox" TargetType="ComboBox" BasedOn="{StaticResource MaterialDesignComboBox}">
            <Setter Property="FontSize" Value="{StaticResource FontSizeBody}"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="MinWidth" Value="180"/>
        </Style>
        
        <Style x:Key="MappedIndicator" TargetType="materialDesign:PackIcon">
            <Setter Property="Kind" Value="Check"/>
            <Setter Property="Width" Value="16"/>
            <Setter Property="Height" Value="16"/>
            <Setter Property="Foreground" Value="{StaticResource LocalSuccessBrush}"/>
            <Setter Property="Visibility" Value="Collapsed"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsMapped}" Value="True">
                    <Setter Property="Visibility" Value="Visible"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
        
        <Style x:Key="AutoMatchedBadge" TargetType="Border">
            <Setter Property="Background" Value="{StaticResource LocalInfoBrush}"/>
            <Setter Property="CornerRadius" Value="3"/>
            <Setter Property="Padding" Value="4,2"/>
            <Setter Property="Margin" Value="4,0,0,0"/>
            <Setter Property="Visibility" Value="Collapsed"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsAutoMatched}" Value="True">
                    <Setter Property="Visibility" Value="Visible"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
        
        <!-- 로컬 버튼 스타일 -->
        <Style x:Key="LocalPrimaryButton" TargetType="Button" BasedOn="{StaticResource MaterialDesignRaisedButton}">
            <Setter Property="Background" Value="{StaticResource LocalPrimaryBrush}"/>
            <Setter Property="Foreground" Value="White"/>
        </Style>
        
        <Style x:Key="LocalSecondaryButton" TargetType="Button" BasedOn="{StaticResource MaterialDesignOutlinedButton}">
            <Setter Property="BorderBrush" Value="{StaticResource LocalBorderBrush}"/>
        </Style>
    </Window.Resources>
    
    <Grid Margin="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- 헤더 -->
        <StackPanel Grid.Row="0" Margin="0,0,0,16">
            <TextBlock FontSize="{StaticResource FontSizeLarge}" 
                       FontWeight="Bold"
                       Foreground="{StaticResource LocalPrimaryBrush}">
                <Run Text="컬럼 매핑 -"/>
                <Run Text="{Binding SheetTypeDisplay, Mode=OneWay}"/>
            </TextBlock>
            <TextBlock Text="{Binding ExcelSheetName, StringFormat='Excel 시트: {0}'}" 
                       FontSize="{StaticResource FontSizeBody}"
                       Foreground="{StaticResource LocalSecondaryTextBrush}"
                       Margin="0,4,0,0"/>
        </StackPanel>
        
        <!-- 툴바 -->
        <Grid Grid.Row="1" Margin="0,0,0,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <StackPanel Grid.Column="0" Orientation="Horizontal">
                <Button Content="기본값 적용" 
                        Click="ApplyDefaults_Click"
                        Style="{StaticResource LocalSecondaryButton}"
                        Padding="16,8"
                        Margin="0,0,8,0"
                        ToolTip="시스템 기본 매핑 규칙을 적용합니다"/>
                <Button Content="초기화" 
                        Click="ClearMappings_Click"
                        Style="{StaticResource LocalSecondaryButton}"
                        Padding="16,8"
                        ToolTip="모든 매핑을 초기화합니다"/>
            </StackPanel>
            
            <TextBlock Grid.Column="2" 
                       VerticalAlignment="Center" 
                       FontSize="{StaticResource FontSizeBody}"
                       Foreground="{StaticResource LocalSecondaryTextBrush}">
                <Run Text="매핑됨:"/>
                <Run Text="{Binding MappedCount, Mode=OneWay}" FontWeight="SemiBold"/>
                <Run Text="/"/>
                <Run Text="{Binding TotalColumns, Mode=OneWay}"/>
            </TextBlock>
        </Grid>
        
        <!-- 컬럼 헤더 -->
        <Border Grid.Row="2" 
                BorderBrush="{StaticResource LocalBorderBrush}"
                BorderThickness="1"
                CornerRadius="8"
                Background="{StaticResource LocalSurfaceBrush}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <!-- 테이블 헤더 -->
                <Border Grid.Row="0" 
                        Background="{StaticResource LocalBlueGray50Brush}"
                        CornerRadius="8,8,0,0"
                        Padding="16,10">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="32"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="40"/>
                            <ColumnDefinition Width="220"/>
                            <ColumnDefinition Width="80"/>
                        </Grid.ColumnDefinitions>
                        
                        <TextBlock Grid.Column="0" Text="#" FontWeight="SemiBold" FontSize="{StaticResource FontSizeBody}"/>
                        <TextBlock Grid.Column="1" Text="Excel 컬럼명" FontWeight="SemiBold" FontSize="{StaticResource FontSizeBody}"/>
                        <TextBlock Grid.Column="2" Text="" FontSize="{StaticResource FontSizeBody}"/>
                        <TextBlock Grid.Column="3" Text="DB 컬럼" FontWeight="SemiBold" FontSize="{StaticResource FontSizeBody}"/>
                        <TextBlock Grid.Column="4" Text="상태" FontWeight="SemiBold" FontSize="{StaticResource FontSizeBody}" HorizontalAlignment="Center"/>
                    </Grid>
                </Border>
                
                <!-- 매핑 목록 -->
                <ScrollViewer Grid.Row="1" 
                              VerticalScrollBarVisibility="Auto"
                              Padding="0">
                    <ItemsControl ItemsSource="{Binding ColumnMappings}" 
                                  AlternationCount="1000"
                                  Margin="0,4,0,4">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Padding="16,8"
                                        BorderBrush="{StaticResource LocalBlueGray100Brush}"
                                        BorderThickness="0,0,0,1">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="32"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="40"/>
                                            <ColumnDefinition Width="220"/>
                                            <ColumnDefinition Width="80"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <!-- 번호 표시용 (바인딩 제거) -->
                                        <TextBlock Grid.Column="0" 
                                                   Text="•"
                                                   VerticalAlignment="Center"
                                                   FontSize="{StaticResource FontSizeSmall}"
                                                   HorizontalAlignment="Center"
                                                   Foreground="{StaticResource LocalSecondaryTextBrush}"/>
                                        
                                        <!-- Excel 컬럼명 -->
                                        <StackPanel Grid.Column="1" 
                                                    Orientation="Horizontal" 
                                                    VerticalAlignment="Center">
                                            <TextBlock Text="{Binding ExcelColumn}" 
                                                       FontSize="{StaticResource FontSizeBody}"
                                                       TextTrimming="CharacterEllipsis"
                                                       MaxWidth="250"
                                                       ToolTip="{Binding ExcelColumn}"/>
                                            <Border Style="{StaticResource AutoMatchedBadge}">
                                                <TextBlock Text="자동" FontSize="{StaticResource FontSizeTiny}" Foreground="White"/>
                                            </Border>
                                            <TextBlock Text="*" 
                                                       Foreground="{StaticResource LocalErrorBrush}"
                                                       FontWeight="Bold"
                                                       Margin="4,0,0,0"
                                                       Visibility="{Binding IsRequired, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                                        </StackPanel>
                                        
                                        <!-- 화살표 -->
                                        <materialDesign:PackIcon Grid.Column="2" 
                                                                  Kind="ArrowRight" 
                                                                  Width="16" Height="16"
                                                                  VerticalAlignment="Center"
                                                                  HorizontalAlignment="Center"
                                                                  Foreground="{StaticResource LocalSecondaryTextBrush}"/>
                                        
                                        <!-- DB 컬럼 선택 -->
                                        <ComboBox Grid.Column="3"
                                                  ItemsSource="{Binding DataContext.AvailableDbColumns, RelativeSource={RelativeSource AncestorType=Window}}"
                                                  SelectedValue="{Binding DbColumn, Mode=TwoWay}"
                                                  SelectedValuePath="DbColumn"
                                                  DisplayMemberPath="DisplayName"
                                                  Style="{StaticResource MappingComboBox}"
                                                  VerticalAlignment="Center"/>
                                        
                                        <!-- 매핑 상태 -->
                                        <StackPanel Grid.Column="4" 
                                                    Orientation="Horizontal" 
                                                    HorizontalAlignment="Center"
                                                    VerticalAlignment="Center">
                                            <materialDesign:PackIcon Style="{StaticResource MappedIndicator}"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </Border>
        
        <!-- 안내문 -->
        <TextBlock Grid.Row="3" 
                   Margin="0,12,0,16"
                   FontSize="{StaticResource FontSizeBody}"
                   Foreground="{StaticResource LocalSecondaryTextBrush}"
                   TextWrapping="Wrap">
            <Run Text="※ 기본값 적용 버튼을 클릭하면 시스템의 자동 매핑 규칙이 적용됩니다."/>
            <LineBreak/>
            <Run Text="※ 필수 컬럼(*)은 반드시 매핑해야 데이터가 정상적으로 업로드됩니다."/>
        </TextBlock>
        
        <!-- 버튼 -->
        <StackPanel Grid.Row="4" 
                    Orientation="Horizontal" 
                    HorizontalAlignment="Right">
            <Button Content="취소" 
                    Click="Cancel_Click"
                    Style="{StaticResource LocalSecondaryButton}"
                    Padding="24,10"
                    Margin="0,0,8,0"/>
            <Button Content="확인" 
                    Click="Confirm_Click"
                    Style="{StaticResource LocalPrimaryButton}"
                    Padding="24,10"/>
        </StackPanel>
    </Grid>
</Window>
