<UserControl x:Class="NPLogic.Views.LoanDetailView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:NPLogic.Views"
             xmlns:vm="clr-namespace:NPLogic.ViewModels"
             xmlns:controls="clr-namespace:NPLogic.Controls;assembly=NPLogic.UI"
             mc:Ignorable="d" 
             d:DesignHeight="900" d:DesignWidth="1600"
             d:DataContext="{d:DesignInstance Type=vm:LoanDetailViewModel}"
             Loaded="LoanDetailView_Loaded">
    
    <UserControl.Resources>
        <!-- 깔끔한 테이블 스타일 (경공매일정과 동일) -->
        <SolidColorBrush x:Key="TableBorderBrush" Color="#E0E0E0"/>
        
        <!-- 섹션 헤더 스타일 -->
        <Style x:Key="SectionHeaderStyle" TargetType="TextBlock">
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="FontSize" Value="{StaticResource FontSizeBody}"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryBrush}"/>
            <Setter Property="Margin" Value="0,0,0,12"/>
        </Style>
        
        <!-- 라벨 스타일 -->
        <Style x:Key="LabelStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="{StaticResource FontSizeSmall}"/>
            <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
            <Setter Property="TextWrapping" Value="NoWrap"/>
        </Style>
        
        <!-- 값 스타일 -->
        <Style x:Key="ValueStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="{StaticResource FontSizeSmall}"/>
            <Setter Property="FontWeight" Value="Medium"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
            <Setter Property="TextWrapping" Value="NoWrap"/>
        </Style>
        
        <!-- 금액 스타일 -->
        <Style x:Key="AmountStyle" TargetType="TextBlock" BasedOn="{StaticResource ValueStyle}">
            <Setter Property="HorizontalAlignment" Value="Right"/>
        </Style>
        
        <!-- 테이블 셀 스타일 -->
        <Style x:Key="TableCellStyle" TargetType="Border">
            <Setter Property="BorderBrush" Value="{StaticResource TableBorderBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,1,1"/>
            <Setter Property="Padding" Value="6,6"/>
            <Setter Property="Background" Value="Transparent"/>
        </Style>
        
        <!-- 테이블 헤더 셀 스타일 -->
        <Style x:Key="TableHeaderCellStyle" TargetType="Border" BasedOn="{StaticResource TableCellStyle}">
            <Setter Property="Background" Value="{StaticResource SurfaceColor}"/>
            <Setter Property="Padding" Value="4,6"/>
        </Style>
        
        <!-- 입력 TextBox 스타일 -->
        <Style x:Key="InputTextBoxStyle" TargetType="TextBox">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
            <Setter Property="BorderBrush" Value="{StaticResource TableBorderBrush}"/>
            <Setter Property="Padding" Value="2,2"/>
            <Setter Property="FontSize" Value="{StaticResource FontSizeSmall}"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
        </Style>
        
        <!-- 읽기 전용 TextBox 스타일 -->
        <Style x:Key="ReadOnlyTextBoxStyle" TargetType="TextBox" BasedOn="{StaticResource InputTextBoxStyle}">
            <Setter Property="IsReadOnly" Value="True"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Foreground" Value="{StaticResource TextSecondaryBrush}"/>
        </Style>
        
        <!-- 컴팩트 CheckBox -->
        <Style x:Key="CompactCheckBoxStyle" TargetType="CheckBox">
            <Setter Property="FontSize" Value="{StaticResource FontSizeBody}"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Margin" Value="0,0,16,0"/>
        </Style>
        
        <!-- 컴팩트 DatePicker -->
        <Style x:Key="CompactDatePickerStyle" TargetType="DatePicker">
            <Setter Property="FontSize" Value="{StaticResource FontSizeTiny}"/>
            <Setter Property="Background" Value="{StaticResource DateInputBgBrush}"/>
            <Setter Property="BorderBrush" Value="{StaticResource DateInputBorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="1"/>
            <Setter Property="Height" Value="22"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="DatePicker">
                        <Border Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <DatePickerTextBox x:Name="PART_TextBox"
                                                   Grid.Column="0"
                                                   Background="Transparent"
                                                   BorderThickness="0"
                                                   Padding="{TemplateBinding Padding}"
                                                   VerticalAlignment="Center"
                                                   VerticalContentAlignment="Center"
                                                   Focusable="{TemplateBinding Focusable}"/>
                                <Button x:Name="PART_Button"
                                        Grid.Column="1"
                                        Width="18"
                                        Focusable="False"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        VerticalAlignment="Center"
                                        HorizontalAlignment="Center"
                                        Padding="1">
                                    <Path Data="M0,0 L0,6 L6,6 L6,0 z M1,1 L1,2 L2,2 L2,1 z M3,1 L3,2 L4,2 L4,1 z M1,3 L1,4 L2,4 L2,3 z M3,3 L3,4 L4,4 L4,3 z"
                                          Fill="#666666"
                                          Width="9"
                                          Height="9"
                                          Stretch="Uniform"/>
                                </Button>
                                <Popup x:Name="PART_Popup"
                                       AllowsTransparency="True"
                                       Placement="Bottom"
                                       PlacementTarget="{Binding ElementName=PART_TextBox}"
                                       StaysOpen="False"/>
                            </Grid>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </UserControl.Resources>
    
    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 헤더 영역 -->
        <Grid Grid.Row="0" Margin="0,0,0,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Grid.Column="0">
                <TextBlock Text="Loan 상세" 
                           Style="{StaticResource H2TextStyle}"
                           Margin="0,0,0,4"/>
                <TextBlock Style="{StaticResource BodyTextStyle}" Opacity="0.7"
                           Visibility="{Binding IsSingleBorrowerMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <Run Text="차주번호:"/>
                    <Run Text="{Binding SelectedBorrower.BorrowerNumber, FallbackValue=-}" FontWeight="SemiBold"/>
                    <Run Text=" | "/>
                    <Run Text="차주명:"/>
                    <Run Text="{Binding SelectedBorrower.BorrowerName, FallbackValue=-}" FontWeight="SemiBold"/>
                </TextBlock>
                <TextBlock Style="{StaticResource BodyTextStyle}" Opacity="0.7"
                           Visibility="{Binding IsSingleBorrowerMode, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                    <Run Text="채권정보 관리 및 Loan Cap 계산 | 총 "/>
                    <Run Text="{Binding Statistics.TotalCount, FallbackValue=0}"/>
                    <Run Text="건"/>
                </TextBlock>
            </StackPanel>

            <StackPanel Grid.Column="1" Orientation="Horizontal">
                <Button Content="Excel 내보내기" 
                        Command="{Binding ExportToExcelCommand}"
                        Style="{StaticResource SecondaryButton}"
                        Padding="16,8"
                        Margin="0,0,8,0"/>
                <Button Content="새로고침" 
                        Command="{Binding RefreshCommand}"
                        Style="{StaticResource PrimaryButton}"
                        Padding="16,8"/>
            </StackPanel>
        </Grid>

        <!-- 통계 카드 (간소화) -->
        <Border Grid.Row="1" Background="{StaticResource SurfaceColor}" CornerRadius="8" Padding="12" Margin="0,0,0,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="24"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="24"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="24"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <TextBlock Text="대출원금잔액 합계: " FontSize="{StaticResource FontSizeBody}" Opacity="0.7" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding Statistics.TotalPrincipalBalance, StringFormat=N0, FallbackValue=0}" 
                               FontSize="{StaticResource FontSizeH4}" FontWeight="Bold" VerticalAlignment="Center"/>
                    <TextBlock Text="원" FontSize="{StaticResource FontSizeSmall}" Opacity="0.7" VerticalAlignment="Center" Margin="2,0,0,0"/>
                </StackPanel>

                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <TextBlock Text="Loan Cap (1안): " FontSize="{StaticResource FontSizeBody}" Opacity="0.7" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding Statistics.TotalLoanCap1, StringFormat=N0, FallbackValue=0}" 
                               FontSize="{StaticResource FontSizeH4}" FontWeight="Bold" Foreground="#2E7D32" VerticalAlignment="Center"/>
                    <TextBlock Text="원" FontSize="{StaticResource FontSizeSmall}" Opacity="0.7" VerticalAlignment="Center" Margin="2,0,0,0"/>
                </StackPanel>

                <StackPanel Grid.Column="4" Orientation="Horizontal">
                    <TextBlock Text="Loan Cap (2안): " FontSize="{StaticResource FontSizeBody}" Opacity="0.7" VerticalAlignment="Center"/>
                    <TextBlock Text="{Binding Statistics.TotalLoanCap2, StringFormat=N0, FallbackValue=0}" 
                               FontSize="{StaticResource FontSizeH4}" FontWeight="Bold" Foreground="#1565C0" VerticalAlignment="Center"/>
                    <TextBlock Text="원" FontSize="{StaticResource FontSizeSmall}" Opacity="0.7" VerticalAlignment="Center" Margin="2,0,0,0"/>
                </StackPanel>

                <!-- 시나리오 날짜 설정 -->
                <StackPanel Grid.Column="6" Orientation="Horizontal">
                    <TextBlock Text="1안 배당일:" FontSize="{StaticResource FontSizeSmall}" VerticalAlignment="Center" Margin="0,0,4,0"/>
                    <DatePicker SelectedDate="{Binding Scenario1Date}" Width="100" Style="{StaticResource DateInputDatePicker}"/>
                    <TextBlock Text="2안 배당일:" FontSize="{StaticResource FontSizeSmall}" VerticalAlignment="Center" Margin="16,0,4,0"/>
                    <DatePicker SelectedDate="{Binding Scenario2Date}" Width="100" Style="{StaticResource DateInputDatePicker}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- 메인 컨텐츠 -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- 차주 및 대출 목록 (좌측) -->
            <Grid Grid.Column="0" Width="240"
                  Visibility="{Binding IsSingleBorrowerMode, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- 검색 -->
                <Grid Grid.Row="0" Margin="0,0,0,8">
                    <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                             VerticalContentAlignment="Center"
                             Padding="10,8">
                        <TextBox.InputBindings>
                            <KeyBinding Key="Enter" Command="{Binding SearchCommand}"/>
                        </TextBox.InputBindings>
                    </TextBox>
                    <TextBlock Text="계좌번호 검색..."
                              VerticalAlignment="Center"
                              Margin="14,0"
                              Opacity="0.5"
                              IsHitTestVisible="False">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding SearchText}" Value="">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </Grid>

                <!-- 차주 목록 -->
                <Border Grid.Row="1" Background="{StaticResource SurfaceColor}" CornerRadius="8" Padding="8" Margin="0,0,0,8">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" Text="차주 선택" FontWeight="SemiBold" FontSize="{StaticResource FontSizeBody}" Margin="4,0,0,4"/>
                        <ListBox Grid.Row="1"
                                 ItemsSource="{Binding Borrowers}"
                                 SelectedItem="{Binding SelectedBorrower}"
                                 Background="Transparent"
                                 BorderThickness="0">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Border Padding="6,4">
                                        <StackPanel>
                                            <TextBlock Text="{Binding BorrowerName}" FontWeight="SemiBold" FontSize="{StaticResource FontSizeBody}"/>
                                            <TextBlock Text="{Binding BorrowerNumber}" FontSize="{StaticResource FontSizeTiny}" Opacity="0.7"/>
                                        </StackPanel>
                                    </Border>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Grid>
                </Border>

                <!-- 대출 목록 -->
                <Border Grid.Row="2" Background="{StaticResource SurfaceColor}" CornerRadius="8" Padding="8">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <TextBlock Grid.Row="0" FontWeight="SemiBold" FontSize="{StaticResource FontSizeBody}" Margin="4,0,0,4">
                            <Run Text="대출 목록 ("/>
                            <Run Text="{Binding Loans.Count, Mode=OneWay, FallbackValue=0}"/>
                            <Run Text="건)"/>
                        </TextBlock>
                        <ListBox Grid.Row="1"
                                 ItemsSource="{Binding Loans}"
                                 SelectedItem="{Binding SelectedLoan}"
                                 Background="Transparent"
                                 BorderThickness="0">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Border Padding="6,4" Margin="0,1">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>
                                            <TextBlock Grid.Row="0" Text="{Binding AccountSerial}" FontWeight="SemiBold" FontSize="{StaticResource FontSizeSmall}"/>
                                            <StackPanel Grid.Row="1" Orientation="Horizontal">
                                                <TextBlock Text="{Binding LoanType}" FontSize="{StaticResource FontSizeTiny}" Opacity="0.7"/>
                                                <TextBlock Text=" | " FontSize="{StaticResource FontSizeTiny}" Opacity="0.5"/>
                                                <TextBlock Text="{Binding LoanPrincipalBalance, StringFormat=N0}" FontSize="{StaticResource FontSizeTiny}"/>
                                            </StackPanel>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                        <Button Grid.Row="2" Content="+ 대출 추가" 
                                Command="{Binding AddLoanCommand}"
                                Style="{StaticResource SecondaryButton}"
                                Padding="10,6"
                                FontSize="{StaticResource FontSizeSmall}"
                                Margin="0,8,0,0"/>
                    </Grid>
                </Border>
            </Grid>

            <!-- 여백 (좌측 패널이 있을 때만) -->
            <Border Grid.Column="1" Width="12"
                    Visibility="{Binding IsSingleBorrowerMode, Converter={StaticResource InverseBooleanToVisibilityConverter}}"/>
            
            <!-- 대출 상세 - 수평 스크롤 지원 -->
            <Border Grid.Column="2" Background="{StaticResource SurfaceColor}" CornerRadius="8" Padding="12">
                <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                    <Grid>
                        <!-- 선택된 대출이 없을 때 -->
                        <TextBlock Text="좌측에서 대출을 선택해주세요"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   Opacity="0.5"
                                   FontSize="{StaticResource FontSizeH4}"
                                   Visibility="{Binding IsSingleBorrowerMode, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding SelectedLoan}" Value="{x:Null}">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>

                        <!-- 단일 차주 모드: 대출 목록 -->
                        <Grid Visibility="{Binding IsSingleBorrowerMode, Converter={StaticResource BooleanToVisibilityConverter}}">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <Grid Grid.Row="0" Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" FontWeight="SemiBold" FontSize="{StaticResource FontSizeBody}">
                                    <Run Text="대출 목록 ("/>
                                    <Run Text="{Binding Loans.Count, Mode=OneWay, FallbackValue=0}"/>
                                    <Run Text="건)"/>
                                </TextBlock>
                                <Button Grid.Column="1" Content="+ 대출 추가" 
                                        Command="{Binding AddLoanCommand}"
                                        Style="{StaticResource SecondaryButton}"
                                        Padding="10,4"
                                        FontSize="{StaticResource FontSizeSmall}"/>
                            </Grid>
                            
                            <ListBox Grid.Row="1"
                                     ItemsSource="{Binding Loans}"
                                     SelectedItem="{Binding SelectedLoan}"
                                     Background="Transparent"
                                     BorderThickness="1"
                                     BorderBrush="{StaticResource BorderColor}"
                                     MaxHeight="80">
                                <ListBox.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ListBox.ItemsPanel>
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Border Padding="8,4" Margin="2" Background="{StaticResource BackgroundColor}" CornerRadius="4">
                                            <StackPanel>
                                                <TextBlock Text="{Binding AccountSerial}" FontWeight="SemiBold" FontSize="{StaticResource FontSizeSmall}"/>
                                                <TextBlock FontSize="{StaticResource FontSizeTiny}" Opacity="0.7">
                                                    <Run Text="{Binding LoanPrincipalBalance, StringFormat=N0}"/>
                                                </TextBlock>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Grid>

                        <!-- 대출 상세 정보 (엑셀 스타일) -->
                        <StackPanel Margin="0,0,0,0">
                            <StackPanel.Style>
                                <Style TargetType="StackPanel">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding SelectedLoan}" Value="{x:Null}">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </StackPanel.Style>

                            <!-- ========== 채권정보 섹션 ========== -->
                            <Border BorderBrush="{StaticResource TableBorderBrush}" BorderThickness="1" Margin="0,0,0,8">
                                <StackPanel>
                                    <TextBlock Text="채권정보" Style="{StaticResource SectionHeaderStyle}"/>
                                    
                                    <!-- 행 1: 기본 정보 -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="105"/>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="70"/>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="70"/>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="85"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="85"/>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="60"/>
                                            <ColumnDefinition Width="50"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <Border Grid.Column="0" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="채권관리번호(A)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="1" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.BondManagementNumber, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="2" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="대출과목(B)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="3" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.LoanType, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="4" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="계좌번호(D)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="5" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.AccountNumber, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="6" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="최초대출금(C)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="7" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.InitialLoanAmount, StringFormat=N0, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="8" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="최초대출일(E)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="9" Style="{StaticResource TableCellStyle}">
                                            <DatePicker SelectedDate="{Binding SelectedLoan.InitialLoanDate}" Style="{StaticResource CompactDatePickerStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="10" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="MO대상" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="11" Style="{StaticResource TableCellStyle}">
                                            <CheckBox IsChecked="{Binding SelectedLoan.IsMoTarget}" Style="{StaticResource CompactCheckBoxStyle}" HorizontalAlignment="Center"/>
                                        </Border>
                                    </Grid>
                                    
                                    <!-- 행 2: 금액 정보 -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="105"/>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="70"/>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="70"/>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="85"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="85"/>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="60"/>
                                            <ColumnDefinition Width="50"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <Border Grid.Column="0" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="대출원금잔액(S)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="1" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.LoanPrincipalBalance, StringFormat=N0, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="2" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="가지급금(H)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="3" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.AdvancePayment, StringFormat=N0, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="4" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="미수이자(I)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="5" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.AccruedInterest, StringFormat=N0, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="6" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="채권잔합계(J)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="7" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.TotalClaimAmount, StringFormat=N0}" Style="{StaticResource ReadOnlyTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="8" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="최종이수일(K)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="9" Style="{StaticResource TableCellStyle}">
                                            <DatePicker SelectedDate="{Binding SelectedLoan.LastInterestDate}" Style="{StaticResource CompactDatePickerStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="10" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="추심상태" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="11" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.CollectionStatus, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                    </Grid>
                                    
                                    <!-- 행 3: 이자율 및 추가 정보 -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="105"/>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="70"/>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="70"/>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="105"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="105"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="60"/>
                                            <ColumnDefinition Width="50"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <Border Grid.Column="0" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="연체이자율(M)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="1" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.OverdueInterestRate, StringFormat=P2, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="2" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="담보이자율(L)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="3" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.CollateralInterestRate, StringFormat=P2, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="4" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="이자율적용" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="5" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.AppliedInterestRate, StringFormat=P2}" Style="{StaticResource ReadOnlyTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="6" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="20년채권잔액(N1)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="7" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.BondBalance20YearN1, StringFormat=N0}" Style="{StaticResource ReadOnlyTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="8" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="20년채권잔액(N2)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="9" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.BondBalance20YearN2, StringFormat=N0}" Style="{StaticResource ReadOnlyTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="10" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="부서/성명" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="11" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.DepartmentPerson, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                    </Grid>
                                    
                                    <!-- 행 4: Interim 정보 -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="105"/>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="70"/>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="70"/>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="85"/>
                                            <ColumnDefinition Width="110"/>
                                            <ColumnDefinition Width="40"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <Border Grid.Column="0" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="원금상계(R)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="1" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.PrincipalOffset, StringFormat=N0, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="2" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="원금회수(S)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="3" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.PrincipalRecovery, StringFormat=N0, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="4" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="이자상계(T)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="5" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.InterestOffset, StringFormat=N0, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="6" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="이자회수(U)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="7" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.InterestRecovery, StringFormat=N0, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="8" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="비고" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="9" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.Notes, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- ========== 보증서요약 섹션 ========== -->
                            <Border BorderBrush="{StaticResource TableBorderBrush}" BorderThickness="1" Margin="0,0,0,8">
                                <StackPanel>
                                    <TextBlock Text="보증서요약" Style="{StaticResource SectionHeaderStyle}"/>
                                    
                                    <!-- 행 1 -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="140"/>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="140"/>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="140"/>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="140"/>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="140"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <Border Grid.Column="0" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="보증기관(B)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="1" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.GuaranteeOrganization, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="2" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="보증번호(N)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="3" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.GuaranteeNumber, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="4" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="해지유배당자(현)(O)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="5" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.TerminationDividendStatus, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="6" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="대위변제금액산정(AC)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="7" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.SubrogationAmountCalculation, StringFormat=N0}" Style="{StaticResource ReadOnlyTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="8" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="대위변제액(AB)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="9" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.SubrogationAmount, StringFormat=N0, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                    </Grid>
                                    
                                    <!-- 행 2 -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="140"/>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="140"/>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="140"/>
                                            <ColumnDefinition Width="120"/>
                                            <ColumnDefinition Width="140"/>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="140"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <Border Grid.Column="0" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="선임료(L)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="1" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.AppointmentFee, StringFormat=N0, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="2" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="대위변제/채권(AD)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="3" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.SubrogationBondRatio, StringFormat=P2}" Style="{StaticResource ReadOnlyTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="4" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="약정이자(AD)" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="5" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.AgreedInterest, StringFormat=N0}" Style="{StaticResource ReadOnlyTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="6" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="대위변제/채권도이자" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="7" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.SubrogationBondInterest, StringFormat=N0}" Style="{StaticResource ReadOnlyTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="8" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="보증가능" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="9" Style="{StaticResource TableCellStyle}">
                                            <CheckBox IsChecked="{Binding SelectedLoan.IsGuaranteeAvailable}" Style="{StaticResource CompactCheckBoxStyle}" HorizontalAlignment="Center"/>
                                        </Border>
                                    </Grid>
                                    
                                    <!-- 체크박스 행 -->
                                    <Grid Background="#F5F5F5">
                                        <WrapPanel Margin="8,4">
                                            <CheckBox Content="유효보증서(O)" IsChecked="{Binding SelectedLoan.HasValidGuarantee}" Style="{StaticResource CompactCheckBoxStyle}"/>
                                            <CheckBox Content="기 대위변제(P)" IsChecked="{Binding SelectedLoan.HasPriorSubrogation}" Style="{StaticResource CompactCheckBoxStyle}"/>
                                            <CheckBox Content="해지부보증(Q)" IsChecked="{Binding SelectedLoan.IsTerminatedGuarantee}" Style="{StaticResource CompactCheckBoxStyle}"/>
                                            <CheckBox Content="Cash In 반영" IsChecked="{Binding SelectedLoan.IsCashInReflected}" Style="{StaticResource CompactCheckBoxStyle}"/>
                                            <CheckBox Content="약정서 확인" IsChecked="{Binding SelectedLoan.HasAgreementDoc}" Style="{StaticResource CompactCheckBoxStyle}"/>
                                        </WrapPanel>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- ========== Loan Cap 섹션 (녹색 배경) ========== -->
                            <Border BorderBrush="{StaticResource TableBorderBrush}" BorderThickness="1" Margin="0,0,0,8">
                                <StackPanel>
                                    <TextBlock Text="Loan Cap" Style="{StaticResource SectionHeaderStyle}" Background="Transparent"/>
                                    
                                    <!-- Loan Cap 1안 / 2안 -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <!-- 1안 -->
                                        <Border Grid.Column="0" BorderBrush="{StaticResource TableBorderBrush}" BorderThickness="0,0,1,0">
                                            <StackPanel>
                                                <TextBlock Text="1안 (시나리오 1)" FontWeight="SemiBold" FontSize="{StaticResource FontSizeBody}" Padding="8,4" Background="#E8F5E9"/>
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="120"/>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="100"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                    </Grid.RowDefinitions>
                                                    
                                                    <Border Grid.Row="0" Grid.Column="0" Style="{StaticResource TableHeaderCellStyle}">
                                                        <TextBlock Text="1안 예상배당가" Style="{StaticResource LabelStyle}"/>
                                                    </Border>
                                                    <Border Grid.Row="0" Grid.Column="1" Style="{StaticResource TableCellStyle}">
                                                        <TextBox Text="{Binding SelectedLoan.ExpectedDividendValue1, StringFormat=N0, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                                    </Border>
                                                    <Border Grid.Row="0" Grid.Column="2" Style="{StaticResource TableHeaderCellStyle}">
                                                        <TextBlock Text="1안 연체이자(AN)" Style="{StaticResource LabelStyle}"/>
                                                    </Border>
                                                    <Border Grid.Row="0" Grid.Column="3" Style="{StaticResource TableCellStyle}">
                                                        <TextBox Text="{Binding SelectedLoan.OverdueInterest1, StringFormat=N0}" Style="{StaticResource ReadOnlyTextBoxStyle}"/>
                                                    </Border>
                                                    
                                                    <Border Grid.Row="1" Grid.Column="0" Style="{StaticResource TableHeaderCellStyle}">
                                                        <TextBlock Text="1안 Loan Cap(LC1)" Style="{StaticResource LabelStyle}"/>
                                                    </Border>
                                                    <Border Grid.Row="1" Grid.Column="1" Style="{StaticResource TableCellStyle}" Background="Transparent">
                                                        <TextBox Text="{Binding SelectedLoan.LoanCap1, StringFormat=N0}" Style="{StaticResource InputTextBoxStyle}" FontWeight="Bold"/>
                                                    </Border>
                                                    <Border Grid.Row="1" Grid.Column="2" Style="{StaticResource TableHeaderCellStyle}">
                                                        <TextBlock Text="보증기준 oLC1" Style="{StaticResource LabelStyle}"/>
                                                    </Border>
                                                    <Border Grid.Row="1" Grid.Column="3" Style="{StaticResource TableCellStyle}">
                                                        <TextBox Text="{Binding SelectedLoan.GuaranteeLoanCap1, StringFormat=N0}" Style="{StaticResource ReadOnlyTextBoxStyle}"/>
                                                    </Border>
                                                    
                                                    <Border Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="4" Style="{StaticResource TableCellStyle}" Background="#F5F5F5">
                                                        <CheckBox Content=">> 1안 배당별 MO 필수 반영" IsChecked="{Binding SelectedLoan.IsMoRequired1}" Style="{StaticResource CompactCheckBoxStyle}" Foreground="#1565C0"/>
                                                    </Border>
                                                </Grid>
                                            </StackPanel>
                                        </Border>
                                        
                                        <!-- 2안 -->
                                        <Border Grid.Column="1">
                                            <StackPanel>
                                                <TextBlock Text="2안 (시나리오 2)" FontWeight="SemiBold" FontSize="{StaticResource FontSizeBody}" Padding="8,4" Background="#E3F2FD"/>
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="120"/>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="100"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="Auto"/>
                                                    </Grid.RowDefinitions>
                                                    
                                                    <Border Grid.Row="0" Grid.Column="0" Style="{StaticResource TableHeaderCellStyle}">
                                                        <TextBlock Text="2안 예상배당가 수수료" Style="{StaticResource LabelStyle}"/>
                                                    </Border>
                                                    <Border Grid.Row="0" Grid.Column="1" Style="{StaticResource TableCellStyle}">
                                                        <TextBox Text="{Binding SelectedLoan.ExpectedDividendFee2, StringFormat=N0, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                                    </Border>
                                                    <Border Grid.Row="0" Grid.Column="2" Style="{StaticResource TableHeaderCellStyle}">
                                                        <TextBlock Text="2안 연체이자(AN)" Style="{StaticResource LabelStyle}"/>
                                                    </Border>
                                                    <Border Grid.Row="0" Grid.Column="3" Style="{StaticResource TableCellStyle}">
                                                        <TextBox Text="{Binding SelectedLoan.OverdueInterest2, StringFormat=N0}" Style="{StaticResource ReadOnlyTextBoxStyle}"/>
                                                    </Border>
                                                    
                                                    <Border Grid.Row="1" Grid.Column="0" Style="{StaticResource TableHeaderCellStyle}">
                                                        <TextBlock Text="2안 Loan Cap(LC2)" Style="{StaticResource LabelStyle}"/>
                                                    </Border>
                                                    <Border Grid.Row="1" Grid.Column="1" Style="{StaticResource TableCellStyle}" Background="Transparent">
                                                        <TextBox Text="{Binding SelectedLoan.LoanCap2, StringFormat=N0}" Style="{StaticResource InputTextBoxStyle}" FontWeight="Bold"/>
                                                    </Border>
                                                    <Border Grid.Row="1" Grid.Column="2" Style="{StaticResource TableHeaderCellStyle}">
                                                        <TextBlock Text="보증기준 oLC2" Style="{StaticResource LabelStyle}"/>
                                                    </Border>
                                                    <Border Grid.Row="1" Grid.Column="3" Style="{StaticResource TableCellStyle}">
                                                        <TextBox Text="{Binding SelectedLoan.GuaranteeLoanCap2, StringFormat=N0}" Style="{StaticResource ReadOnlyTextBoxStyle}"/>
                                                    </Border>
                                                    
                                                    <Border Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="4" Style="{StaticResource TableCellStyle}" Background="#F5F5F5">
                                                        <CheckBox Content=">> 2안 배당별 MO 필수 반영" IsChecked="{Binding SelectedLoan.IsMoRequired2}" Style="{StaticResource CompactCheckBoxStyle}" Foreground="#1565C0"/>
                                                    </Border>
                                                </Grid>
                                            </StackPanel>
                                        </Border>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- ========== MCI 보증+ 섹션 ========== -->
                            <Border BorderBrush="{StaticResource TableBorderBrush}" BorderThickness="1" Margin="0,0,0,8">
                                <StackPanel>
                                    <Grid Background="{StaticResource SurfaceColor}">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0" Text="MCI 보증+" Style="{StaticResource SectionHeaderStyle}" Background="Transparent"/>
                                        <CheckBox Grid.Column="1" Content="MCI 대상" IsChecked="{Binding SelectedLoan.IsMciTarget}" Style="{StaticResource CompactCheckBoxStyle}" Margin="0,0,8,0" FontWeight="SemiBold"/>
                                    </Grid>
                                    
                                    <!-- MCI 정보 행 -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="140"/>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="140"/>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="140"/>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="100"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <Border Grid.Column="0" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="MCI대출거래업체" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="1" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.MciLoanTrader, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="2" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="대출번호" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="3" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.MciLoanNumber, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="4" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="주요상품분류" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="5" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.MciProductCategory, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="6" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="정상여부" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="7" Style="{StaticResource TableCellStyle}">
                                            <CheckBox IsChecked="{Binding SelectedLoan.IsMciNormal}" Style="{StaticResource CompactCheckBoxStyle}" HorizontalAlignment="Center" Content="정상"/>
                                        </Border>
                                        
                                        <Border Grid.Column="8" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="청구지급율" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="9" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.MciClaimPaymentRate, StringFormat=P2, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                    </Grid>
                                    
                                    <!-- MCI 금액 행 -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="140"/>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="140"/>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="140"/>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="140"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <Border Grid.Column="0" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="MCI최초가입금액" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="1" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.MciInitialAmount, StringFormat=N0, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="2" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="MCI가입잔액" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="3" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.MciBalance, StringFormat=N0, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="4" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="MCI보증서번호" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="5" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.MciGuaranteeNumber, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="6" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="MCI채권번호" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="7" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.MciBondNumber, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- ========== 기타항목 및 변경 섹션 ========== -->
                            <Border BorderBrush="{StaticResource TableBorderBrush}" BorderThickness="1" Margin="0,0,0,8">
                                <StackPanel>
                                    <TextBlock Text="기타항목 및 변경" Style="{StaticResource SectionHeaderStyle}"/>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="100"/>
                                            <ColumnDefinition Width="140"/>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="140"/>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="140"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <Border Grid.Column="0" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="구분" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="1" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.OtherItemCategory, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="2" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="지급" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="3" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.OtherItemPayment, StringFormat=N0, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                        
                                        <Border Grid.Column="4" Style="{StaticResource TableHeaderCellStyle}">
                                            <TextBlock Text="회수" Style="{StaticResource LabelStyle}"/>
                                        </Border>
                                        <Border Grid.Column="5" Style="{StaticResource TableCellStyle}">
                                            <TextBox Text="{Binding SelectedLoan.OtherItemRecovery, StringFormat=N0, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource InputTextBoxStyle}"/>
                                        </Border>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- ========== 버튼 영역 ========== -->
                            <Border Background="#F5F5F5" Padding="12" CornerRadius="4">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                                        <Button Content="Loan Cap 재계산" 
                                                Command="{Binding RecalculateLoanCapCommand}"
                                                Style="{StaticResource SecondaryButton}"
                                                Padding="16,8"
                                                FontSize="{StaticResource FontSizeBody}"
                                                Margin="0,0,8,0"/>
                                        <Button Content="전체 일괄 계산" 
                                                Command="{Binding RecalculateAllLoanCapsCommand}"
                                                Style="{StaticResource SecondaryButton}"
                                                Padding="16,8"
                                                FontSize="{StaticResource FontSizeBody}"
                                                Margin="0,0,8,0"/>
                                        <Button Content="저장" 
                                                Command="{Binding SaveLoanCommand}"
                                                Style="{StaticResource PrimaryButton}"
                                                Padding="24,8"
                                                FontSize="{StaticResource FontSizeBody}"/>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </StackPanel>
                    </Grid>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- 로딩 오버레이 -->
        <Border Grid.RowSpan="3" Background="#80000000" CornerRadius="8"
                Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <ProgressBar IsIndeterminate="True" Width="200"/>
                <TextBlock Text="로딩 중..." Foreground="White" Margin="0,16,0,0"/>
            </StackPanel>
        </Border>

        <!-- 에러 메시지 -->
        <Border Grid.Row="2" Background="#E57373" CornerRadius="8" Padding="16" Margin="0,16,0,0"
                VerticalAlignment="Bottom"
                Visibility="{Binding ErrorMessage, Converter={StaticResource NullToVisibilityConverter}}">
            <TextBlock Text="{Binding ErrorMessage}" Foreground="White" TextWrapping="Wrap"/>
        </Border>
    </Grid>
</UserControl>
